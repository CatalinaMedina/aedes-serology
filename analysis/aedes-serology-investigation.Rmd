---
title: "Aedes serology investigation"
author: "Catalina Medina"
date: "4/5/2021"
geometry: margin=0.5cm
output: pdf_document
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
params:
  rerun_data: TRUE
  rerun_fit1_bayes: FALSE
  rerun_fit2_bayes: FALSE
  rerun_fit3_bayes: FALSE
  rerun_fit4_bayes: FALSE
  rerun_fit1_freq: FALSE
  rerun_fit2_freq: FALSE
  rerun_fit3_freq: FALSE
  rerun_fit4_freq: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.pos = "h"
)
```


```{r libraries}
library(tidyverse)
library(here)
library(readxl)
library(janitor)
library(viridis)
library(zoo)
library(qwraps2)
library(knitr)
library(kableExtra)
library(lubridate)
library(rstanarm)
library(bayesplot)
library(gridExtra)
library(lme4)


source(here("analysis", "process-modis-data-function.R"))

seed_val <- 1423
set.seed(seed_val)
```


```{r read-process-data}
if (params$rerun_data) {
  ##### read-process-survey-data
  
  saliva_ELISA_log_shift <- 0.15
  
  sched_visit_names <- c(
    "VISIT 1 DENGUE INDEX",
    "VISIT 2  DENGUE INDEX",
    "VISIT 3 DENGUE INDEX",
    "VISIT 4 INDEX"
  )
  
  low_count_schools <- c( # schools with <= 5 study participants with saliva measurement
    "Amnor Antarak Cheat School",
    "Ampe Phnom",
    "Aphivodth", 
    "Christian School Khum Skus",
    "Kdey Amnor", 
    "Kindergarten Asian",
    "Kindergarten Kampuchea Asian",
    "Kindergarten Wattbor",
    "Kindergarten​ Salon",
    "Meatophoum School",
    "No Name",
    "Panha Bot School",
    "Phoumi Thmei",
    "Sinsisamuth"
  ) 
  
  
  aedes_survey_og <- read_excel(here("data", "pagodas_combined_data3.xlsx"))
  
  
  aedes_survey_cleaned <- aedes_survey_og %>% 
    clean_names() %>% 
    mutate(age = as.numeric(age)) %>% 
    mutate(age_cented = age - 6) %>% 
    mutate(gender = factor(gender)) %>% 
    mutate(school_attended = str_to_title(school_attended)) %>% 
    mutate(specify_if_other = str_to_title(specify_if_other)) %>% 
    mutate(school_attended_all = ifelse(
      school_attended == "Other, Specify:",
      yes = specify_if_other,
      no = school_attended
    )) %>% 
    mutate(school_attended_all = factor(
      case_when(
        school_attended_all == "New Town" ~ "Kindergarten New Town",
        school_attended_all %in% c("Sin Si Sa Muth", "Sinsisamuth") ~ "Kindergarten Sin Si Sa Muth",
        school_attended_all == "Panha Bot" ~ "Panha Bot School",
        school_attended_all == "No Name" ~ "NA",
        TRUE ~ school_attended_all
      ))) %>% 
    mutate(school_attended_all = as.character(school_attended_all)) %>%
    mutate(in_school = factor(ifelse(
      school_attended_all != "Subject Not In School",
      yes = "yes",
      no = "no"
    ))) %>% 
    mutate(school_attended_red = factor(
      case_when(
        school_attended_all %in% low_count_schools ~ "other",
        TRUE ~ school_attended_all
      ),
      levels = c(
        "Subject Not In School",
        "Ang Seri",              
        "Anouvotta",             
        "Mroum Cheung",          
        "Mroum Tbaung",          
        "New Town",
        "Rkathom",
        "Santiphap",
        "Kindergarten Sin Si Sa Muth",
        "other"
      )
    )) %>% 
    select(-c("specify_if_other")) %>% 
    mutate(housing_type = factor(housing_type)) %>% 
    mutate(socioeconomic_class = factor(
      socioeconomic_class,
      levels = c("Very Poor", "Lower", "Middle", "Upper")
    )) %>% 
    mutate(visit_date = as.Date(visit_date)) %>% 
    mutate(sched_visit = ifelse(visit %in% sched_visit_names, yes = "yes", no = "no")) %>% 
    mutate(num_domestic_water_containers_in_home = as.numeric(num_domestic_water_containers_in_home)) %>% 
    mutate(num_toilets_in_home = as.numeric(num_toilets_in_home)) %>% 
    mutate(how_often_use_bed_net = factor(
      how_often_use_bed_net,
      levels = c(
        "Never", 
        "Rarely", 
        "Regularly/ Most of the time", 
        "All of the time"
      ),
      labels = c(
        "Never", 
        "Rarely", 
        "Most of the time", 
        "All of the time"
      )
    )) %>% 
    mutate(insecticide_spray = factor(insecticide_spray)) %>% 
    mutate(larvicide_applied_to_water = factor(larvicide_applied_to_water)) %>% 
    mutate(how_often_mosquito_coils_burned = factor(
      how_often_mosquito_coils_burned,
      levels = c(
        "Never", 
        "Rarely (about 1x/month)", 
        "Sometimes (about 1x/week)",
        "Often (about 3x/week)",
        "Daily"
      ),
      labels = c(
        "Never", 
        "~ 1x/month", 
        "~ 1x/week",
        "~ 3x/week",
        "Daily"
      )
    )) %>% 
    mutate(visit_date_abr = factor(as.yearmon(visit_date))) %>% 
    mutate(log_saliva_elisa = log(saliva_elisa_value + saliva_ELISA_log_shift)) 
  
  
  aedes_visit5 <- read_csv(here("data", "Saliva ELISA V1-6 INDEX.csv")) %>% 
    select(study_id = ID, saliva_elisa_value = "Visit 5") %>% 
    mutate(saliva_elisa_value = as.numeric(ifelse(saliva_elisa_value == ".", yes = NA, no = saliva_elisa_value))) %>% 
    mutate(log_saliva_elisa = log(saliva_elisa_value + saliva_ELISA_log_shift))

  aedes_survey_cleaned_v1_v5 <- aedes_survey_cleaned[!duplicated(aedes_survey_cleaned$study_id), ] %>% 
      mutate(visit = "Visit 5") %>% 
      mutate(visit_date = as.Date("2020-07-01")) %>% 
      mutate(visit_date_abr = NA) %>% 
      select(-c(saliva_elisa_value, log_saliva_elisa)) %>% 
      full_join(aedes_visit5) %>% 
      select(colnames(aedes_survey_cleaned)) %>% 
      bind_rows(aedes_survey_cleaned) %>% 
      arrange(study_id, visit_date)
      
  
  aedes_coord_og <- read_csv(here("data", "PAGODAS_Coordinates.csv"))
  
  aedes_coord_cleaned <- aedes_coord_og %>%
    clean_names()
  
  aedes_full <- full_join(aedes_survey_cleaned_v1_v5, aedes_coord_cleaned) %>% 
    filter(sched_visit == "yes") %>% 
    mutate(visit = factor(case_when(
      visit == "VISIT 1 DENGUE INDEX" ~ "visit1",
      visit == "VISIT 2  DENGUE INDEX" ~ "visit2",
      visit == "VISIT 3 DENGUE INDEX" ~ "visit3",
      visit == "VISIT 4 INDEX" ~ "visit4",
      visit == "Visit 5" ~ "visit5",
      TRUE ~ "NA"
    )))
  
  aedes_red <- aedes_full %>% 
    filter(!is.na(saliva_elisa_value)) %>% 
    filter(!is.na(visit_date)) 
  
  aedes_red <- aedes_red[!(aedes_red$school_attended_all == "NA"), ]
  
  #### Incorporate satellite data
  sat_data500 <- process_modis_data(
    df_og = read_csv(here("data", "MODIS_500m.csv")), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 7
  ) %>% 
    arrange(Study.ID, var_type, date)
  
  
  sat_df <- sat_data500
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  max_date_diff <- 40
  date_lag <- 16
  
  
  for(i in 1:nrow(df_og)) {
    df_id <- sat_df %>% 
      filter(Study.ID == as.character(df_og[i, "study_id"]))
    
    for(j in 1:num_vars) {
      df_id_var <- df_id %>% 
        filter(var_type == var_types[j])
      
      if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
        date_diff <- (df_og$visit_date[i] - days(date_lag)) - df_id_var$date
        curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
        
        if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
          print(paste0(
            "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
            var_types[j], " value available within ", max_date_diff, 
            " days [max_date_diff] of ", date_lag, " days [date_lag] prior to visit date!"
          ))
        } else {
          df_new[i, var_types[j]] <- curr$sat_var_value
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI500_home = EVI, NVI500_home = NVI, NFI500_home = NFI)
  
  
  #### Incorporate satellite data 
  sat_data250 <- process_modis_data(
    df_og = read_csv(here("data", "MODIS_250m.csv")), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 7
  )
  
  
  sat_df <- sat_data250
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  max_date_diff <- 40
  date_lag <- 16
  
  
  for(i in 1:nrow(df_og)) {
    df_id <- sat_df %>% 
      filter(Study.ID == as.character(df_og[i, "study_id"]))
    
    for(j in 1:num_vars) {
      df_id_var <- df_id %>% 
        filter(var_type == var_types[j])
      
      if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
        date_diff <- (df_og$visit_date[i] - days(date_lag)) - df_id_var$date
        curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
        
        if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
          print(paste0(
            "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
            var_types[j], " value available within ", max_date_diff, 
            " days [max_date_diff] of ", date_lag, " days [date_lag] prior to visit date!"
          ))
        } else {
          df_new[i, var_types[j]] <- curr$sat_var_value
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI250_home = EVI, NVI250_home = NVI, NFI250_home = NFI)
  
  
  #### Incorporate school satellite data 
  sat_data250 <- process_modis_data(
    df_og = read_csv(here("data", "SchoolsMODIS_250m.csv")), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 6
  ) %>% 
    mutate(names = ifelse(
      names == "Kindergarten<U+200B> Salon", 
      yes = "Kindergarten​ Salon", 
      no = names
    ))
  
  
  sat_df <- sat_data250
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  max_date_diff <- 40
  date_lag <- 16
  
  
  for(i in 1:nrow(df_og)) {
    if(df_og[i, "school_attended_all"] != "Subject Not In School") {
      df_id <- sat_df %>% 
        filter(names == as.character(df_og[i, "school_attended_all"]))
      
      for(j in 1:num_vars) {
        df_id_var <- df_id %>% 
          filter(var_type == var_types[j])
        
        if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
          date_diff <- (df_og$visit_date[i] - days(date_lag)) - df_id_var$date
          curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
          
          if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
            print(paste0(
              "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
              var_types[j], " value available within ", max_date_diff, 
              " days [max_date_diff] of ", date_lag, " days [date_lag] prior to visit date!"
            ))
          } else {
            df_new[i, var_types[j]] <- curr$sat_var_value
          }
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI250_sch = EVI, NVI250_sch = NVI, NFI250_sch = NFI) %>% 
    mutate(EVI250_sch = ifelse(is.na(EVI250_sch), yes = EVI250_home, no = EVI250_sch)) %>% 
    mutate(NVI250_sch = ifelse(is.na(NVI250_sch), yes = NVI250_home, no = NVI250_sch)) %>% 
    mutate(NFI250_sch = ifelse(is.na(NFI250_sch), yes = NFI250_home, no = NFI250_sch))                 
  
  
  saveRDS(aedes_red, file = here("data", "processed_aedes_data.rds"))
  
} else { 
  aedes_red <- readRDS(file = here("data", "processed_aedes_data.rds")) 
}
  
aedes_red_ind <- aedes_red %>%
  filter(visit == "visit1") %>% 
  mutate(visit = droplevels(visit)) 
```


```{r visit_measurement_counts}
summary(aedes_red$visit)
```

\newpage
## EDA table

```{r eda_tab}
aedes_summary <- list(
  "Age" = list(
    "min" = ~ min(age),
    "mean (sd)" = ~ mean_sd(age),
    "max" = ~ max(age)
  ),
  "Gender" = list(
    "Male" = ~ n_perc0(gender == "Female"),
    "Female" = ~ n_perc0(gender == "Male")
  ),
  "School attended" = list(
    "Ampe phnom" = ~ n_perc0(school_attended == "Ampe phnom"),
    "Ang seri" = ~ n_perc0(school_attended == "Ang seri"),
    "Anouvotta" = ~ n_perc0(school_attended == "Anouvotta"),
    "Aphivodth" = ~ n_perc0(school_attended == "Aphivodth"),
    "Mroum cheung" = ~ n_perc0(school_attended == "Mroum cheung"),
    "Mroum tbaung" = ~ n_perc0(school_attended == "Mroum tbaung"),
    "Phoumi thmei" = ~ n_perc0(school_attended == "Phoumi thmei"),
    "Rkathom" = ~ n_perc0(school_attended == "Rkathom"),
    "Santiphap" = ~ n_perc0(school_attended == "Santiphap"),
    "Other" = ~ n_perc0(school_attended == "Other, specify:"),
    "Not in school" = ~ n_perc0(school_attended == "Subject not in school")
  ),
  "Socioeconomic class" = list(
    "Lower" = ~ n_perc0(socioeconomic_class == "Lower"),
    "Middle" = ~ n_perc0(socioeconomic_class == "Middle"),
    "Upper" = ~ n_perc0(socioeconomic_class == "Upper"),
    "Very Poor" = ~ n_perc0(socioeconomic_class == "Very Poor")
  ),
  "Domestic water containers" = list(
    "min" = ~ min(num_domestic_water_containers_in_home),
    "mean (sd)" = ~ mean_sd(num_domestic_water_containers_in_home),
    "max" = ~ max(num_domestic_water_containers_in_home)
  ),
  "Number toilets in home" = list(
    "min" = ~ min(num_toilets_in_home),
    "mean (sd)" = ~ mean_sd(num_toilets_in_home),
    "max" = ~ max(num_toilets_in_home)
  ),
  "Bed net use" = list(
    "Never" = ~ n_perc0(how_often_use_bed_net == "Never"),
    "Rarely" = ~ n_perc0(how_often_use_bed_net == "Rarely"),
    "Regularly/ Most of the time" = ~ n_perc0(how_often_use_bed_net == "Regularly/ Most of the time"),
    "All of the time" = ~ n_perc0(how_often_use_bed_net == "All of the time")
  ),
  "Insecticide spray" = list(
    "No" = ~ n_perc0(insecticide_spray == "No"),
    "Yes" = ~ n_perc0(insecticide_spray == "Yes")
  ),
  "Larvicide applied to water" = list(
    "No" = ~ n_perc0(larvicide_applied_to_water == "No"),
    "Yes" = ~ n_perc0(larvicide_applied_to_water == "Yes")
  ),
  "Mosquito coils burned" = list(
    "Never" = ~ n_perc0(how_often_mosquito_coils_burned == "Never"),
    "Rarely (about 1x/month)" = ~ n_perc0(how_often_mosquito_coils_burned == "Rarely (about 1x/month)"),
    "Sometimes (about 1x/week)" = ~ n_perc0(how_often_mosquito_coils_burned == "Sometimes (about 1x/week)"),
    "Often (about 3x/week)" = ~ n_perc0(how_often_mosquito_coils_burned == "Often (about 3x/week)"),
    "Daily" = ~ n_perc0(how_often_mosquito_coils_burned == "Daily")
  )
)

aedes_summary_tab <- summary_table(aedes_red_ind, aedes_summary)

kable(aedes_summary_tab) %>% 
  kable_styling(latex_options = "HOLD_position") %>% 
  group_rows(group_label = "Age", start_row = 1, end_row = 3) %>% 
  group_rows(group_label = "Gender", 4, 5) %>% 
  group_rows(group_label = "School attended", 6, 16) %>% 
  group_rows(group_label = "Socioeconomic level", 17, 20) %>% 
  group_rows(group_label = "Domestic water containers", 21, 23) %>% 
  group_rows(group_label = "Number toilets in home", 24, 26) %>% 
  group_rows(group_label = "Bed net use", 27, 30) %>% 
  group_rows(group_label = "Insecticide spray", 31, 32) %>% 
  group_rows(group_label = "Larvicide applied to water", 33, 34) %>% 
  group_rows(group_label = "Mosquito coils burned", 35, 39)
```

\newpage

```{r saliva-elisa-mapped, fig.dim=c(8,8.25)}
aedes_red %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = saliva_elisa_value)) +
    geom_point(alpha = 0.75) +
    scale_color_viridis(direction = -1) +
    theme_bw() +
    lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
    coord_equal(ratio = 1) +
    facet_wrap(~ visit) +
    theme(legend.position="bottom")
```

\newpage

```{r saliva-elisa-mapped-extreme-dropped, fig.dim=c(8,8.25)}
aedes_red %>% 
  filter(study_id != "100-0022") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = saliva_elisa_value)) +
    geom_point(alpha = 0.75) +
    scale_color_viridis(direction = -1) +
    theme_bw() +
    lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
    coord_equal(ratio = 1) +
    facet_wrap(~ visit) +
    theme(legend.position="bottom")
```

\newpage

```{r elisa-by-visit, fig.asp=0.7}
aedes_red %>% 
  ggplot(mapping = aes(x = visit, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r elisa-by-visit_date, fig.asp=0.7}
aedes_red %>% 
  ggplot(mapping = aes(x = visit_date, y = saliva_elisa_value)) +
    geom_point() +
    theme_bw() +
    ggtitle("Saliva ELISA value by visit data")
```

\newpage

```{r elisa-by-elevation, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = elevation, y = saliva_elisa_value)) +
    geom_point() +
  theme_bw()
```


```{r elevation-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = elevation)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```


\newpage

## Plots of saliva ELISA value by predictors

```{r elisa-by-age, fig.asp=0.6}
aedes_red_ind %>% 
  mutate(age = factor(age)) %>% 
  ggplot(mapping = aes(x = age, y = saliva_elisa_value)) +
  geom_boxplot() +
  theme_bw()
```


```{r age-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(age = factor(age)) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = age)) +
  geom_point() +
  scale_color_viridis(discrete = TRUE, direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-gender, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = gender, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r gender-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = gender, shape = gender)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-school_attended, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = school_attended, y = saliva_elisa_value)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90))
```


```{r school_attended-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = school_attended)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-num_domestic_water_containers_in_home, fig.asp=0.7}
aedes_red_ind %>% 
  mutate(num_domestic_water_containers_in_home = factor(num_domestic_water_containers_in_home)) %>% 
  ggplot(mapping = aes(x = num_domestic_water_containers_in_home, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw() +
  xlab("Number of domestic water containers in home") +
  ylab("Saliva ELISA value")
```


```{r num_domestic_water_containers_in_home-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(water_cont = num_domestic_water_containers_in_home) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = water_cont)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  scale_color_viridis(direction = -1) +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-num_toilets_in_home, fig.asp=0.7}
aedes_red_ind %>% 
  mutate(num_toilets_in_home = factor(num_toilets_in_home)) %>% 
  ggplot(mapping = aes(x = num_toilets_in_home, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw() +
  xlab("Number of toilets in home") +
  ylab("Saliva ELISA value")
```


```{r num_toilets_in_home-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(toilets = num_toilets_in_home) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = toilets)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  scale_color_viridis(direction = -1) +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-how_often_use_bed_net, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = how_often_use_bed_net, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r how_often_use_bed_net-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(bed_net = how_often_use_bed_net) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = bed_net)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  scale_color_viridis(direction = -1, discrete = TRUE) +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-insecticide_spray, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = insecticide_spray, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw() +
  xlab("Insecticide") +
  ylab("Saliva ELISA value")
```


```{r insecticide_spray-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(insecticide = insecticide_spray) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = insecticide)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-larvicide_applied_to_water, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = larvicide_applied_to_water, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw() +
  xlab("Larvicide") +
  ylab("Saliva ELISA value")
```


```{r larvicide_applied_to_water-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(larvicide = larvicide_applied_to_water) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = larvicide)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-how_often_mosquito_coils_burned, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = how_often_mosquito_coils_burned, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r how_often_mosquito_coils_burned-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(coils = how_often_mosquito_coils_burned) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = coils)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1, discrete = TRUE) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-EVI, fig.asp=0.7, eval = FALSE}
aedes_red %>% 
  ggplot(mapping = aes(x = EVI, y = saliva_elisa_value)) +
    geom_point() +
  theme_bw() +
  facet_wrap(~ visit)
```


```{r EVI-visit1-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit1") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = EVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 1")
```


```{r EVI-visit2-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit2") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = EVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 2")
```


```{r EVI-visit3-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit3") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = EVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 3")
```


```{r EVI-visit4-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit4") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = EVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 4")
```


```{r elisa-by-NFI, fig.asp=0.7, eval = FALSE}
aedes_red %>% 
  ggplot(mapping = aes(x = NFI, y = saliva_elisa_value)) +
    geom_point() +
  theme_bw() +
  facet_wrap(~ visit)
```


```{r NFI-visit1-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit1") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NFI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 1")
```


```{r NFI-visit2-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit2") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NFI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 2")
```


```{r NFI-visit3-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit3") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NFI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 3")
```


```{r NFI-visit4-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit4") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NFI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 4")
```

\newpage

```{r elisa-by-NVI, fig.asp=0.7, eval = FALSE}
aedes_red %>% 
  ggplot(mapping = aes(x = NVI, y = saliva_elisa_value)) +
    geom_point() +
  theme_bw() +
  facet_wrap(~ visit)
```


```{r NVI-visit1-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit1") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 1")
```


```{r NVI-visit2-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit2") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 2")
```


```{r NVI-visit3-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit3") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 3")
```


```{r NVI-visit4-mapped, fig.asp=0.9, eval = FALSE}
aedes_red %>% 
  filter(visit == "visit4") %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = NVI)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1) +
  ggtitle("Visit 4")
```




## Pairwise plots of predictors
```{r pariwise-plots-of-predictors, eval = FALSE}
library(GGally)

pdf(here("analysis", "preds-pair-plot.pdf"), width = 40, height = 30)

ggpairs(aedes_red_ind[, c(3:5, 8:14, 29, 36:39)])

dev.off()
```








\newpage

## Model 

```{r, eval = FALSE}
ggplot(aedes_red_ind, aes(x = saliva_elisa_value)) +
  geom_histogram()


ggplot(aedes_red, aes(x = log(saliva_elisa_value + 0.015))) +
  geom_histogram() +
  theme_bw()
```

Initial model for log saliva ELISA value of individual $i$ at measurement $j$ ($i=1,...,726$, $j=1,...,4$).
\begin{equation*}
	\begin{split}
		\log(\text{Saliva ELISA value})_{ij} &= b_{0_{i}} + \beta_{0} + \beta_{1}\text{Male}_i + \beta_{2-10}\text{School}_{i} \\
		&+ \beta_{11}(\text{Age} - 6)_{i} + \beta_{12}\text{Toilets}_{i} + \beta{13}\text{Water Containers}_i + \beta_{14}\text{Insecticide}_{i} + \beta_{15}\text{Larvicide}_{i} \\
		&+ \beta_{16}\text{NFI}_{ij} + \beta_{17}\text{NVI}_{ij} \\
		&+ \beta_{18}\text{Visit2}_{ij} + \beta_{19}\text{Visit3}_{ij} + \beta_{20}\text{Visit4}_{ij},
	\end{split}
\end{equation*}
with "subject not in school" as reference group for school covariate.

```{r fit1-bayes-NVI500}
if(params$rerun_fit1_bayes) {
  fit1_bayes <- stan_lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + num_domestic_water_containers_in_home + 
      insecticide_spray + larvicide_applied_to_water +
      NFI500_home + NVI500_home + visit,
    data = aedes_red,
    seed = seed_val
  )
  
  saveRDS(fit1_bayes, file = here("output", "fit1-bayes.rds"))
  
} else { 
  fit1_bayes <- readRDS(file = here("output", "fit1-bayes.rds")) 
}
```


```{r fit2-bayes-NVI250}
if(params$rerun_fit2_bayes) {
  fit2_bayes <- stan_lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + num_domestic_water_containers_in_home + 
      insecticide_spray + larvicide_applied_to_water +
      NFI250_home + NVI250_home + visit,
    data = aedes_red,
    seed = seed_val
  )
  
  saveRDS(fit2_bayes, file = here("output", "fit2-bayes.rds"))
  
} else { 
  fit2_bayes <- readRDS(file = here("output", "fit2-bayes.rds")) 
}
```


```{r fit3-bayes-EVI500}
if(params$rerun_fit3_bayes) {
  fit3_bayes <- stan_lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + num_domestic_water_containers_in_home +
      insecticide_spray + larvicide_applied_to_water +
      NFI500_home + EVI500_home + visit,
    data = aedes_red,
    seed = seed_val
  )
  
  saveRDS(fit3_bayes, file = here("output", "fit3-bayes.rds"))
  
} else { 
  fit3_bayes <- readRDS(file = here("output", "fit3-bayes.rds")) 
}
```


```{r fit4-bayes-EVI250}
if(params$rerun_fit4_bayes) {
  fit4_bayes <- stan_lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + num_domestic_water_containers_in_home +
      insecticide_spray + larvicide_applied_to_water +
      NFI250_home + EVI250_home + visit,
    data = aedes_red,
    seed = seed_val
  )
  
  saveRDS(fit4_bayes, file = here("output", "fit4-bayes.rds"))
  
} else { 
  fit4_bayes <- readRDS(file = here("output", "fit4-bayes.rds")) 
}
```

\blandscape

```{r gen_post_plots-function}
gen_post_plots <- function(fit){
  fit_post_area1 <- mcmc_areas(fit, regex_pars = "school") +
    scale_y_discrete(labels = c(
      "school_attended_redAng Seri" = "Ang Seri",
      "school_attended_redAnouvotta" = "Anouvotta",
      "school_attended_redMroum Cheung" = "Mroum Cheung",
      "school_attended_redMroum Tbaung" = "Mroum Tbaung",
      "school_attended_redNew Town" = "New Town",
      "school_attended_redPanha Bot" = "Panha Bot",
      "school_attended_redRkathom" = "Rkathom",
      "school_attended_redSantiphap" = "Santiphap",
      "school_attended_redSin Si Sa Muth" = "Sin Si Sa Muth",
      "school_attended_redother" = "other"
    ))
  
  fit_post_area2 <- mcmc_areas(
    fit,
    regex_pars = c("gender", "age", "toilets", "water", "insecticide", "larvicide")
  )
  
  fit_post_area3 <- mcmc_areas(fit, regex_pars = c("NFI", "NVI", "EVI"))
  
  fit_post_area4 <- mcmc_areas(fit, regex_pars = c("visit")) 
  
  grid.arrange(
    fit_post_area1, fit_post_area2, fit_post_area3, fit_post_area4, 
    nrow = 2
  )
}
```


Fit 1 (NVI500) Results
```{r fit1-bayes-results, fig.width=10, fig.height=7.5}
gen_post_plots(fit1_bayes)
```


\newpage

Fit 2 (NVI250) Results
```{r fit2-bayes-results, fig.width=10, fig.height=7.5}
gen_post_plots(fit2_bayes)
```

\newpage

Fit 3 (EVI500) Results
```{r fit3-bayes-results, fig.width=10, fig.height=7.5}
gen_post_plots(fit3_bayes)
```


\newpage

Fit 4 (EVI250) Results
```{r fit4-bayes-results, fig.width=10, fig.height=7.5}
gen_post_plots(fit4_bayes)
```

\elandscape


```{r trace-plots, eval = FALSE}
mcmc_trace(fit1_bayes, regex_pars = "school")
mcmc_trace(fit2_bayes, regex_pars = "school")
mcmc_trace(fit3_bayes, regex_pars = "school")
mcmc_trace(fit4_bayes, regex_pars = "school")

mcmc_trace(fit1_bayes, regex_pars = c("gender", "age", "toilets", "water", "insecticide", "larvicide"))
mcmc_trace(fit2_bayes, regex_pars = c("gender", "age", "toilets", "water", "insecticide", "larvicide"))
mcmc_trace(fit3_bayes, regex_pars = c("gender", "age", "toilets", "water", "insecticide", "larvicide"))
mcmc_trace(fit4_bayes, regex_pars = c("gender", "age", "toilets", "water", "insecticide", "larvicide"))

mcmc_trace(fit1_bayes, regex_pars = c("NFI", "NVI"))
mcmc_trace(fit2_bayes, regex_pars = c("NFI", "NVI"))
mcmc_trace(fit3_bayes, regex_pars = c("NFI", "EVI"))
mcmc_trace(fit4_bayes, regex_pars = c("NFI", "EVI"))

mcmc_trace(fit1_bayes, regex_pars = c("visit"))
mcmc_trace(fit2_bayes, regex_pars = c("visit"))
mcmc_trace(fit3_bayes, regex_pars = c("visit"))
mcmc_trace(fit4_bayes, regex_pars = c("visit"))
```


\newpage
## Frequentist fit
```{r fit1-freq-NVI500}
if(params$rerun_fit1_freq) {
  fit1_freq <- lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + insecticide_spray + larvicide_applied_to_water +
      NFI500_home + NVI500_home + visit,
    data = aedes_red
  )
  
  saveRDS(fit1_freq, file = here("output", "fit1-freq.rds"))
  
} else { 
  fit1_freq <- readRDS(file = here("output", "fit1-freq.rds")) 
}
```


```{r fit2-freq-NVI250}
if(params$rerun_fit2_freq) {
  fit2_freq <- lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + insecticide_spray + larvicide_applied_to_water +
      NFI250_home + NVI250_home + visit,
    data = aedes_red
  )
  
  saveRDS(fit2_freq, file = here("output", "fit2-freq.rds"))
  
} else { 
  fit2_freq <- readRDS(file = here("output", "fit2-freq.rds")) 
}
```


```{r fit3-freq-EVI500}
if(params$rerun_fit3_freq) {
  fit3_freq <- lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + insecticide_spray + larvicide_applied_to_water +
      NFI500_home + EVI500_home + visit,
    data = aedes_red
  )
  
  saveRDS(fit3_freq, file = here("output", "fit3-freq.rds"))
  
} else { 
  fit3_freq <- readRDS(file = here("output", "fit3-freq.rds")) 
}
```


```{r fit4-freq-EVI250}
if(params$rerun_fit1_freq) {
  fit4_freq <- lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + school_attended_red + 
      age_cented + num_toilets_in_home + insecticide_spray + larvicide_applied_to_water +
      NFI250_home + EVI250_home + visit,
    data = aedes_red
  )
  
  saveRDS(fit4_freq, file = here("output", "fit4-freq.rds"))
  
} else { 
  fit4_freq <- readRDS(file = here("output", "fit4-freq.rds")) 
}
```


```{r gen_res_plot-function}
gen_res_plot <- function(fit){
  fit_freq_sum <- summary(fit)
  coeffs <- data.frame(fit_freq_sum$coefficients)[-1, ]
  fit_res <- data.frame(
    pred = rownames(coeffs),
    "estimates" = coeffs$Estimate,
    "lb95" = coeffs$Estimate - qnorm(0.025) * coeffs$Std..Error,
    "up95" = coeffs$Estimate + qnorm(0.025) * coeffs$Std..Error
  )
  rownames(fit_res) <- rownames(coeffs)
  
  ggplot(fit_res, mapping = aes(x = estimates, y = pred)) +
    geom_point() +
    geom_linerange(aes(xmin = lb95, xmax = up95)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    scale_y_discrete(limits = rev(fit_res$pred)) +
    theme_bw()
}
```


```{r fit1-freq-NVI500-results}
gen_res_plot(fit1_freq)
```


```{r fit2-freq-NVI250-results}
gen_res_plot(fit2_freq)
```


```{r fit3-freq-EVI500-results}
gen_res_plot(fit3_freq)
```


```{r fit3-freq-EVI250-results}
gen_res_plot(fit4_freq)
```


## Updated model with school modis  

Updated model for log saliva ELISA value of individual $i$ at measurement $j$ ($i=1,...,726$, $j=1,...,4$).
\begin{equation*}
	\begin{split}
		\log(\text{Saliva ELISA value})_{ij} &= b_{0_{i}} + \beta_{0} + \beta_{1}\text{Male}_i \\
		&+ \beta_{2}(\text{Age} - 6)_{i} + \beta_{3}\text{Toilets}_{i} + \beta{4}\text{Water Containers}_i + \beta_{5}\text{Insecticide}_{i} + \beta_{6}\text{Larvicide}_{i} \\
		&+ \beta_{7}\text{NFI250_home}_{ij} + \beta_{8}\text{EVI250_home}_{ij} \\
		&+ \beta_{9}\text{NFI250_sch}_{ij} + \beta_{10}\text{EVI250_sch}_{ij} \\
		&+ \beta_{11}\text{Visit2}_{ij} + \beta_{12}\text{Visit3}_{ij} + \beta_{13}\text{Visit4}_{ij},
	\end{split}
\end{equation*}


```{r fit5-bayes-EVI250}
if(params$rerun_fit5_bayes) {
  fit5_bayes <- stan_lmer(
    formula = log_saliva_elisa ~ (1 | study_id) + 1 + gender + 
      age_cented + num_toilets_in_home + num_domestic_water_containers_in_home + 
      insecticide_spray + larvicide_applied_to_water +
      NFI250_home + EVI250_home + NFI250_sch + EVI250_sch + visit,
    data = aedes_red,
    seed = seed_val
  )
  
  saveRDS(fit5_bayes, file = here("output", "fit5-bayes.rds"))
  
} else { 
  fit5_bayes <- readRDS(file = here("output", "fit5-bayes.rds")) 
}
```


```{r}
gen_post_plots <- function(fit){
  fit_post_area1 <- mcmc_areas(
    fit,
    regex_pars = c("gender", "age", "toilets", "water", "insecticide", "larvicide")
  )
  
  fit_post_area2 <- mcmc_areas(fit, regex_pars = c("NFI250_home", "NVI250_home", "EVI250_home")) 
  
  fit_post_area3 <- mcmc_areas(fit, regex_pars = c("NFI250_sch", "NVI250_sch", "EVI250_sch"))
  
  fit_post_area4 <- mcmc_areas(fit, regex_pars = c("visit")) 
  
  grid.arrange(
    fit_post_area1, fit_post_area2, fit_post_area3, fit_post_area4, 
    nrow = 2
  )
}

gen_post_plots(fit5_bayes)
```

