---
title: "Aedes serology investigation"
author: "Catalina Medina"
date: "4/5/2021"
output: pdf_document
geometry: margin=0.5cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.pos = "h"
)
```


```{r libraries}
library(tidyverse)
library(here)
library(readxl)
library(janitor)
library(viridis)
library(zoo)
library(qwraps2)
library(knitr)
library(kableExtra)
library(lubridate)
```


```{r read-process-survey-data}
sched_visit_names <- c(
  "VISIT 1 DENGUE INDEX",
  "VISIT 2  DENGUE INDEX",
  "VISIT 3 DENGUE INDEX",
  "VISIT 4 INDEX"
)

aedes_survey_og <- read_excel(here("data", "pagodas_combined_data3.xlsx"))
aedes_survey_cleaned <- aedes_survey_og %>% 
  clean_names() %>% 
  mutate(visit = factor(visit)) %>% 
  mutate(age = as.numeric(age)) %>% 
  mutate(gender = factor(gender)) %>% 
  mutate(school_attended = factor(school_attended)) %>% 
  mutate(housing_type = factor(housing_type)) %>% 
  mutate(socioeconomic_class = factor(
    socioeconomic_class,
    levels = c("Very Poor", "Lower", "Middle", "Upper")
  )) %>% 
  mutate(visit_date = as.Date(visit_date)) %>% 
  mutate(sched_visit = ifelse(visit %in% sched_visit_names, yes = "yes", no = "no")) %>% 
  mutate(num_domestic_water_containers_in_home = as.numeric(num_domestic_water_containers_in_home)) %>% 
  mutate(num_toilets_in_home = as.numeric(num_toilets_in_home)) %>% 
  mutate(how_often_use_bed_net = factor(
    how_often_use_bed_net,
    levels = c(
      "Never", 
      "Rarely", 
      "Regularly/ Most of the time", 
      "All of the time"
    ),
    labels = c(
      "Never", 
      "Rarely", 
      "Most of the time", 
      "All of the time"
    )
  )) %>% 
  mutate(insecticide_spray = factor(insecticide_spray)) %>% 
  mutate(larvicide_applied_to_water = factor(larvicide_applied_to_water)) %>% 
  mutate(how_often_mosquito_coils_burned = factor(
    how_often_mosquito_coils_burned,
    levels = c(
      "Never", 
      "Rarely (about 1x/month)", 
      "Sometimes (about 1x/week)",
      "Often (about 3x/week)",
      "Daily"
    ),
    labels = c(
      "Never", 
      "~ 1x/month", 
      "~ 1x/week",
      "~ 3x/week",
      "Daily"
    )
  )) %>% 
  mutate(visit_date_abr = factor(as.yearmon(visit_date)))

aedes_coord_og <- read_csv(here("data", "PAGODAS_Coordinates.csv"))
aedes_coord_cleaned <- aedes_coord_og %>%
  clean_names()

aedes_full <- full_join(aedes_survey_cleaned, aedes_coord_cleaned)  

aedes_red_ind <- aedes_full %>%
  filter(!is.na(saliva_elisa_value)) %>% 
  filter(visit == "VISIT 1 DENGUE INDEX") %>% 
  mutate(visit = droplevels(visit)) 
```


```{r read-process-spatial-data1}
# what column do the environmental variables start?
sat_var_col_start <- 7
sat_var_names <- c("EVI", "NVI", "NFI") # keep order that it appear in df
id_col_name <- "Study.ID"
df_og <- read_csv(here("data", "MODIS_500m.csv"))


# sort_sat_data function start
df_og <- data.frame(df_og[-1, ])
num_vars <- length(sat_var_names)

sat_cols <- sat_var_col_start:ncol(df_og)
non_sat_cols <- 1:(sat_var_col_start - 1)


# assume dates are the same
df_og[, sat_cols]


new_df <- data.frame(matrix(
  NA, 
  nrow = nrow(df_og) * length(sat_cols) ,
  ncol = length(non_sat_cols) +  3
))

colnames(new_df) <- c(
  colnames(df_og)[non_sat_cols], 
  "date", "var_type", "sat_var_ind"
)

new_df$date <- as.Date(new_df$date)

new_row <- 1

for(i in 1:nrow(df_og)) {
  for(j in 0:(length(sat_cols) - 1)) {
    new_df[new_row + j, non_sat_cols] <- as.vector(df_og[i, non_sat_cols])
    col_name_ex <- str_split(colnames(df_og[, sat_cols])[j + 1], pattern = "_")
    measure_date <- as.Date(paste0("20", col_name_ex[[1]][2], "-01-01")) +
      days(as.numeric(col_name_ex[[1]][3]) - 1)
    
    new_df[new_row + j, "date"] <- measure_date
    new_df[new_row + j, "var_type"] <- col_name_ex[[1]][1]
    new_df[new_row + j, "sat_var_ind"] <- df_og[i, sat_cols]
  }
  
  new_row <- new_row + length(sat_cols)
}
```


```{r read-process-spatial-data2}
this_date <- "2019-12-27"
this_var <- "NVI"
this_id <- "100-0007"

num_cols_nonsat <- 6

df_og <- read_csv(here("data", "MODIS_500m.csv"))

var_cols <- colnames(df_og)[-(1:num_cols_nonsat)]

df_new <- df_og

colnames(df_new) <- c(
  colnames(df_og)[1:num_cols_nonsat], 
  paste0(
    str_sub(var_cols, 1, 3), ".",
    as.Date(paste0("20", str_sub(var_cols, 5, 6), "-01-01")) + 
      days(as.numeric(str_sub(var_cols, 8, 10)) - 1)
  )
)

this_var_cols <- str_sub(colnames(df_new), 1, 3) == this_var 
this_date_cols <- str_sub(colnames(df_new), 5, 14) == this_date

df_new[df_new$Study.ID == this_id, this_var_cols & this_date_cols]
```


```{r visit_measurement_counts}
aedes_full %>% 
  filter(!is.na(saliva_elisa_value)) %>% 
  select(visit) %>% 
  summary()
```

\newpage
## EDA table

```{r eda_tab}
aedes_summary <- list(
  "Age" = list(
    "min" = ~ min(age),
    "mean (sd)" = ~ mean_sd(age),
    "max" = ~ max(age)
  ),
  "Gender" = list(
    "Male" = ~ n_perc0(gender == "Female"),
    "Female" = ~ n_perc0(gender == "Male")
  ),
  "School attended" = list(
    "Ampe phnom" = ~ n_perc0(school_attended == "Ampe phnom"),
    "Ang seri" = ~ n_perc0(school_attended == "Ang seri"),
    "Anouvotta" = ~ n_perc0(school_attended == "Anouvotta"),
    "Aphivodth" = ~ n_perc0(school_attended == "Aphivodth"),
    "Mroum cheung" = ~ n_perc0(school_attended == "Mroum cheung"),
    "Mroum tbaung" = ~ n_perc0(school_attended == "Mroum tbaung"),
    "Phoumi thmei" = ~ n_perc0(school_attended == "Phoumi thmei"),
    "Rkathom" = ~ n_perc0(school_attended == "Rkathom"),
    "Santiphap" = ~ n_perc0(school_attended == "Santiphap"),
    "Other" = ~ n_perc0(school_attended == "Other, specify:"),
    "Not in school" = ~ n_perc0(school_attended == "Subject not in school")
  ),
  "Socioeconomic class" = list(
    "Lower" = ~ n_perc0(socioeconomic_class == "Lower"),
    "Middle" = ~ n_perc0(socioeconomic_class == "Middle"),
    "Upper" = ~ n_perc0(socioeconomic_class == "Upper"),
    "Very Poor" = ~ n_perc0(socioeconomic_class == "Very Poor")
  ),
  "Domestic water containers" = list(
    "min" = ~ min(num_domestic_water_containers_in_home),
    "mean (sd)" = ~ mean_sd(num_domestic_water_containers_in_home),
    "max" = ~ max(num_domestic_water_containers_in_home)
  ),
  "Number toilets in home" = list(
    "min" = ~ min(num_toilets_in_home),
    "mean (sd)" = ~ mean_sd(num_toilets_in_home),
    "max" = ~ max(num_toilets_in_home)
  ),
  "Bed net use" = list(
    "Never" = ~ n_perc0(how_often_use_bed_net == "Never"),
    "Rarely" = ~ n_perc0(how_often_use_bed_net == "Rarely"),
    "Regularly/ Most of the time" = ~ n_perc0(how_often_use_bed_net == "Regularly/ Most of the time"),
    "All of the time" = ~ n_perc0(how_often_use_bed_net == "All of the time")
  ),
  "Insecticide spray" = list(
    "No" = ~ n_perc0(insecticide_spray == "No"),
    "Yes" = ~ n_perc0(insecticide_spray == "Yes")
  ),
  "Larvicide applied to water" = list(
    "No" = ~ n_perc0(larvicide_applied_to_water == "No"),
    "Yes" = ~ n_perc0(larvicide_applied_to_water == "Yes")
  ),
  "Mosquito coils burned" = list(
    "Never" = ~ n_perc0(how_often_mosquito_coils_burned == "Never"),
    "Rarely (about 1x/month)" = ~ n_perc0(how_often_mosquito_coils_burned == "Rarely (about 1x/month)"),
    "Sometimes (about 1x/week)" = ~ n_perc0(how_often_mosquito_coils_burned == "Sometimes (about 1x/week)"),
    "Often (about 3x/week)" = ~ n_perc0(how_often_mosquito_coils_burned == "Often (about 3x/week)"),
    "Daily" = ~ n_perc0(how_often_mosquito_coils_burned == "Daily")
  )
)

aedes_summary_tab <- summary_table(aedes_red_ind, aedes_summary)
kable(aedes_summary_tab) %>% 
  kable_styling(latex_options = "HOLD_position") %>% 
  group_rows(group_label = "Age", start_row = 1, end_row = 3) %>% 
  group_rows(group_label = "Gender", 4, 5) %>% 
  group_rows(group_label = "School attended", 6, 16) %>% 
  group_rows(group_label = "Socioeconomic level", 17, 20) %>% 
  group_rows(group_label = "Domestic water containers", 21, 23) %>% 
  group_rows(group_label = "Number toilets in home", 24, 26) %>% 
  group_rows(group_label = "Bed net use", 27, 30) %>% 
  group_rows(group_label = "Insecticide spray", 31, 32) %>% 
  group_rows(group_label = "Larvicide applied to water", 33, 34) %>% 
  group_rows(group_label = "Mosquito coils burned", 35, 39)
```

\newpage

```{r saliva-elisa-mapped, fig.dim=c(8,8.25)}
aedes_full %>% 
  filter(sched_visit == "yes") %>% 
  filter(!is.na(saliva_elisa_value)) %>% 
  mutate(visit = droplevels(visit)) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = saliva_elisa_value)) +
    geom_point(alpha = 0.75) +
    scale_color_viridis(direction = -1) +
    theme_bw() +
    lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
    coord_equal(ratio = 1) +
    facet_wrap(~ visit) +
    theme(legend.position="bottom")
```

\newpage

```{r saliva-elisa-mapped-extreme-dropped, fig.dim=c(8,8.25)}
aedes_full %>% 
  filter(sched_visit == "yes") %>% 
  filter(!is.na(saliva_elisa_value)) %>% 
  filter(study_id != "100-0022") %>% 
  mutate(visit = droplevels(visit)) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = saliva_elisa_value)) +
    geom_point(alpha = 0.75) +
    scale_color_viridis(direction = -1) +
    theme_bw() +
    lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
    coord_equal(ratio = 1) +
    facet_wrap(~ visit) +
    theme(legend.position="bottom")
```

\newpage

```{r elisa-by-visit, fig.asp=0.7}
aedes_full %>% 
  filter(sched_visit == "yes") %>%  
  filter(!is.na(saliva_elisa_value)) %>% 
  ggplot(mapping = aes(x = visit, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r elisa-by-visit_date, fig.asp=0.7}
aedes_full %>% 
  filter(!is.na(saliva_elisa_value)) %>% 
  filter(sched_visit == "yes") %>% 
  ggplot(mapping = aes(x = visit_date, y = saliva_elisa_value)) +
    geom_point() +
    theme_bw() +
    ggtitle("Saliva ELISA value by visit data")
```

\newpage

```{r elisa-by-elevation, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = elevation, y = saliva_elisa_value)) +
    geom_point() +
  theme_bw()
```


```{r elevation-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = elevation)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```


\newpage

## Plots of saliva ELISA value by predictors

```{r elisa-by-age, fig.asp=0.6}
aedes_red_ind %>% 
  mutate(age = factor(age)) %>% 
  ggplot(mapping = aes(x = age, y = saliva_elisa_value)) +
  geom_boxplot() +
  theme_bw()
```


```{r age-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(age = factor(age)) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = age)) +
  geom_point() +
  scale_color_viridis(discrete = TRUE, direction = -1) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-gender, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = gender, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r gender-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = gender, shape = gender)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-school_attended, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = school_attended, y = saliva_elisa_value)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90))
```


```{r school_attended-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = school_attended)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-num_domestic_water_containers_in_home, fig.asp=0.7}
aedes_red_ind %>% 
  mutate(num_domestic_water_containers_in_home = factor(num_domestic_water_containers_in_home)) %>% 
  ggplot(mapping = aes(x = num_domestic_water_containers_in_home, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r num_domestic_water_containers_in_home-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(water_cont = num_domestic_water_containers_in_home) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = water_cont)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  scale_color_viridis(direction = -1) +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-num_toilets_in_home, fig.asp=0.7}
aedes_red_ind %>% 
  mutate(num_toilets_in_home = factor(num_toilets_in_home)) %>% 
  ggplot(mapping = aes(x = num_toilets_in_home, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r num_toilets_in_home-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(toilets = num_toilets_in_home) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = toilets)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  scale_color_viridis(direction = -1) +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-how_often_use_bed_net, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = how_often_use_bed_net, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r how_often_use_bed_net-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(bed_net = how_often_use_bed_net) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = bed_net)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  scale_color_viridis(direction = -1, discrete = TRUE) +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-insecticide_spray, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = insecticide_spray, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r insecticide_spray-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(insecticide = insecticide_spray) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = insecticide)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-larvicide_applied_to_water, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = larvicide_applied_to_water, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r larvicide_applied_to_water-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(larvicide = larvicide_applied_to_water) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = larvicide)) +
  geom_point(alpha = 0.75) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

\newpage

```{r elisa-by-how_often_mosquito_coils_burned, fig.asp=0.7}
aedes_red_ind %>% 
  ggplot(mapping = aes(x = how_often_mosquito_coils_burned, y = saliva_elisa_value)) +
    geom_boxplot() +
  theme_bw()
```


```{r how_often_mosquito_coils_burned-mapped, fig.asp=0.9}
aedes_red_ind %>% 
  mutate(coils = how_often_mosquito_coils_burned) %>% 
  ggplot(mapping = aes(x = lon, y = lat, color = coils)) +
  geom_point(alpha = 0.75) +
  scale_color_viridis(direction = -1, discrete = TRUE) +
  theme_bw() +
  lims(x = c(104.50, 104.56), y = c(11.43, 11.49)) +
  coord_equal(ratio = 1)
```

