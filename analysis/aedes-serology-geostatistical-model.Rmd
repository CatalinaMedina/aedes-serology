---
title: "INLA spde modeling of individual level Aedes mosquito exposure among Cambodian children"
output: pdf_document
header-includes:
  - \usepackage{float}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
classoption: landscape
params:
  rerun_data: FALSE
  near_river_cut_off: 300
  modis_lag: 32
  refit_fit: FALSE
  refit_vistit_fit: FALSE
  refit_larval_fit: FALSE
  refit_aedes_fit: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, eval = FALSE, 
  fig.pos = 'H', fig.align = "center",
  message = FALSE, warning = FALSE
)
```


```{r libraries, eval = TRUE}
library(here)
library(readxl)
library(janitor)
library(zoo)
library(RANN)
library(viridis)
library(gridExtra)
library(knitr)
library(sf)
library(ggsn)
library(ggmap)
library(lattice)
library(magrittr)
library(knitr)
library(kableExtra)
library(INLAutils)
library(tidyverse)

library(INLA)

source(here("analysis", "process-modis-data-function.R"))
```


```{r read-process-data}
if (params$rerun_data) {
  ##### read-process-survey-data
  
  saliva_ELISA_log_shift <- 0.15
  
  sched_visit_names <- c(
    "VISIT 1 DENGUE INDEX",
    "VISIT 2  DENGUE INDEX",
    "VISIT 3 DENGUE INDEX",
    "VISIT 4 INDEX"
  )
  
  low_count_schools <- c( # schools with <= 5 study participants with saliva measurement
    "Amnor Antarak Cheat School",
    "Ampe Phnom",
    "Aphivodth", 
    "Christian School Khum Skus",
    "Kdey Amnor", 
    "Kindergarten Asian",
    "Kindergarten Kampuchea Asian",
    "Kindergarten Wattbor",
    "Kindergarten​ Salon",
    "Meatophoum School",
    "No Name",
    "Panha Bot School",
    "Phoumi Thmei",
    "Sinsisamuth"
  ) 
  
  
  aedes_survey_og <- read_excel(here("data", "pagodas_combined_data3.xlsx"))
  
  
  aedes_survey_cleaned <- aedes_survey_og %>% 
    clean_names() %>% 
    mutate(wet_season = ifelse(
      visit %in% c("VISIT 1 DENGUE INDEX", "VISIT 3 DENGUE INDEX"),
      yes = "yes",
      no = "no"
    )) %>% 
    mutate(visit_year = case_when(
      visit == "VISIT 1 DENGUE INDEX" ~ 0,
      visit %in% c("VISIT 2  DENGUE INDEX", "VISIT 3 DENGUE INDEX") ~ 1,
      visit == "VISIT 4 INDEX" ~ 2,
      TRUE ~ -99
    )) %>% 
    mutate(age = as.numeric(age)) %>% 
    mutate(age_cented3 = age - 3) %>%
    mutate(age_cented7 = age - 7) %>%
    mutate(age_cented = age - 6) %>%
    mutate(gender = factor(gender)) %>% 
    mutate(school_attended = str_to_title(school_attended)) %>% 
    mutate(specify_if_other = str_to_title(specify_if_other)) %>% 
    mutate(school_attended_all = ifelse(
      school_attended == "Other, Specify:",
      yes = specify_if_other,
      no = school_attended
    )) %>% 
    mutate(school_attended_all = factor(
      case_when(
        school_attended_all == "New Town" ~ "Kindergarten New Town",
        school_attended_all %in% c("Sin Si Sa Muth", "Sinsisamuth") ~ "Kindergarten Sin Si Sa Muth",
        school_attended_all == "Panha Bot" ~ "Panha Bot School",
        school_attended_all == "No Name" ~ "NA",
        TRUE ~ school_attended_all
      ))) %>% 
    mutate(school_attended_all = as.character(school_attended_all)) %>%
    mutate(in_school = factor(ifelse(
      school_attended_all != "Subject Not In School",
      yes = "yes",
      no = "no"
    ))) %>% 
    mutate(school_attended_red = factor(
      case_when(
        school_attended_all %in% low_count_schools ~ "other",
        TRUE ~ school_attended_all
      ),
      levels = c(
        "Subject Not In School",
        "Ang Seri",              
        "Anouvotta",             
        "Mroum Cheung",          
        "Mroum Tbaung",          
        "New Town",
        "Rkathom",
        "Santiphap",
        "Kindergarten Sin Si Sa Muth",
        "other"
      )
    )) %>% 
    select(-c("specify_if_other")) %>% 
    mutate(housing_type = factor(housing_type)) %>% 
    mutate(socioeconomic_class = factor(
      socioeconomic_class,
      levels = c("Very Poor", "Lower", "Middle", "Upper")
    )) %>% 
    mutate(visit_date = as.Date(visit_date)) %>% 
    mutate(sched_visit = ifelse(visit %in% sched_visit_names, yes = "yes", no = "no")) %>% 
    mutate(num_domestic_water_containers_in_home = as.numeric(num_domestic_water_containers_in_home)) %>% 
    mutate(num_toilets_in_home = as.numeric(num_toilets_in_home)) %>% 
    mutate(how_often_use_bed_net = factor(
      how_often_use_bed_net,
      levels = c(
        "Never", 
        "Rarely", 
        "Regularly/ Most of the time", 
        "All of the time"
      ),
      labels = c(
        "Never", 
        "Rarely", 
        "Most of the time", 
        "All of the time"
      )
    )) %>% 
    mutate(insecticide_spray = factor(insecticide_spray)) %>% 
    mutate(larvicide_applied_to_water = factor(larvicide_applied_to_water)) %>% 
    mutate(how_often_mosquito_coils_burned = factor(
      how_often_mosquito_coils_burned,
      levels = c(
        "Never", 
        "Rarely (about 1x/month)", 
        "Sometimes (about 1x/week)",
        "Often (about 3x/week)",
        "Daily"
      ),
      labels = c(
        "Never", 
        "~ 1x/month", 
        "~ 1x/week",
        "~ 3x/week",
        "Daily"
      )
    )) %>% 
    mutate(visit_date_abr = factor(as.yearmon(visit_date))) %>% 
    mutate(log_saliva_elisa = log(saliva_elisa_value + saliva_ELISA_log_shift)) 
  
  
  aedes_visit5 <- read_csv(here("data", "Saliva ELISA V1-6 INDEX.csv"), show_col_types = FALSE) %>% 
    select(study_id = ID, saliva_elisa_value = "Visit 5") %>% 
    mutate(saliva_elisa_value = as.numeric(ifelse(saliva_elisa_value == ".", yes = NA, no = saliva_elisa_value))) %>% 
    mutate(log_saliva_elisa = log(saliva_elisa_value + saliva_ELISA_log_shift)) 
    

  aedes_survey_cleaned_v1_v5 <- aedes_survey_cleaned[!duplicated(aedes_survey_cleaned$study_id), ] %>% 
      mutate(visit = "Visit 5") %>% 
      mutate(visit_date = as.Date("2020-07-01")) %>% 
      mutate(visit_date_abr = NA) %>% 
      mutate(wet_season = "yes") %>% 
      mutate(visit_year = 2) %>% 
      select(-c(saliva_elisa_value, log_saliva_elisa)) %>% 
      full_join(aedes_visit5) %>% 
      select(colnames(aedes_survey_cleaned)) %>% 
      bind_rows(aedes_survey_cleaned) %>% 
      arrange(study_id, visit_date)
  
  
  aedes_coord_og <- read_csv(here("data", "PAGODAS_Coordinates.csv"), show_col_types = FALSE)
  
  aedes_coord_cleaned <- aedes_coord_og %>%
    clean_names()
  
  aedes_full <- full_join(aedes_survey_cleaned_v1_v5, aedes_coord_cleaned) %>% 
    filter(sched_visit == "yes") %>% 
    mutate(visit = case_when(
      visit == "VISIT 1 DENGUE INDEX" ~ "visit1",
      visit == "VISIT 2  DENGUE INDEX" ~ "visit2",
      visit == "VISIT 3 DENGUE INDEX" ~ "visit3",
      visit == "VISIT 4 INDEX" ~ "visit4",
      visit == "Visit 5" ~ "visit5",
      TRUE ~ "NA"
    ))

  aedes_survey_with_river <- read_csv(here("data", "DistPHHtoRiver.csv"), show_col_types = FALSE) %>% 
    select(study_id = Study.ID, distance_to_river = distance) %>%
    mutate(distance_to_river_scaled = (distance_to_river - mean(distance_to_river)) / sd(distance_to_river)) %>% 
    mutate(close_to_river = factor(
      ifelse(distance_to_river <= params$near_river_cut_off, "yes", "no"), 
      levels = c("no", "yes")
    )) %>% 
    right_join(aedes_full)
  
  
  aedes_red <- aedes_survey_with_river %>% 
    filter(!is.na(saliva_elisa_value)) %>% 
    filter(!is.na(visit_date)) %>% 
    filter(school_attended_all != "NA") %>% 
    mutate(num_domestic_water_containers_in_home = ifelse(
      visit != "visit1", 
      yes = NA, 
      no = num_domestic_water_containers_in_home
    )) %>% 
    mutate(num_toilets_in_home = ifelse(
      visit != "visit1", 
      yes = NA, 
      no = num_toilets_in_home
    )) %>% 
    mutate(how_often_use_bed_net = ifelse(
      visit != "visit1", 
      yes = NA, 
      no = as.character(how_often_use_bed_net)
    )) %>% 
    mutate(insecticide_spray = ifelse(
      visit != "visit1", 
      yes = NA, 
      no = as.character(insecticide_spray)
    )) %>%
    mutate(larvicide_applied_to_water = ifelse(
      visit != "visit1", 
      yes = NA, 
      no = as.character(larvicide_applied_to_water)
    )) %>%
    mutate(how_often_mosquito_coils_burned = ifelse(
      visit != "visit1", 
      yes = NA, 
      no = as.character(how_often_mosquito_coils_burned)
    ))

  
  time_varying <- read_xlsx(here("data", "AllVisitDataWithScheDengueRiskFactors.xlsx")) %>% 
    select(
      study_id = "Study ID", 
      visit = "Event Name",
      num_domestic_water_containers_in_home = "1. How many domestic water containers are in the subject's home?",
      num_toilets_in_home = "2. How many toilets are in the subject's home?",
      how_often_use_bed_net = "3. How often does the subject use a bed net?",
      insecticide_spray = "4. Is the subject's home sprayed with insecticide?",
      larvicide_applied_to_water = "5. Is larvicide applied to water containers at the subject's home?",
      how_often_mosquito_coils_burned = "6. How often are mosquito coils burned in the subject's house?",
    ) %>% 
    mutate(visit = gsub(" ", "", str_to_lower(visit), fixed = TRUE)) %>%
    filter(visit != "visit6") %>% 
    filter(!(study_id == "100-0468" & visit == "visit4")) %>% # Missing data
    mutate(num_domestic_water_containers_in_home = as.numeric(num_domestic_water_containers_in_home)) %>% 
    mutate(num_toilets_in_home = as.numeric(num_toilets_in_home)) %>% 
    mutate(how_often_use_bed_net = as.character(factor(
      how_often_use_bed_net,
      levels = c(
        "Never", 
        "Rarely", 
        "Regularly/ Most of the time", 
        "All the time"
      ),
      labels = c(
        "Never", 
        "Rarely", 
        "Most of the time", 
        "All of the time"
      )
    ))) %>% 
    mutate(how_often_mosquito_coils_burned = as.character(factor(
      how_often_mosquito_coils_burned,
      levels = c(
        "Never", 
        "Rarely (about 1x/month)", 
        "Sometimes (about 1x/week)",
        "Often (about 3x/week)",
        "Daily"
      ),
      labels = c(
        "Never", 
        "~ 1x/month", 
        "~ 1x/week",
        "~ 3x/week",
        "Daily"
      )
    )))
  
  time_varying_vars <- c("num_domestic_water_containers_in_home", "num_toilets_in_home", "how_often_use_bed_net", "insecticide_spray", "larvicide_applied_to_water", "how_often_mosquito_coils_burned")
  
  
  aedes_red <- aedes_red %>% 
    filter(visit != "visit1") %>% 
    select(-time_varying_vars) %>% 
    left_join(time_varying) %>% 
    select(colnames(aedes_red)) %>% 
    bind_rows(aedes_red %>% filter(visit == "visit1")) %>% 
    mutate(visit = factor(visit)) %>% 
    mutate(visit5 = factor(ifelse(visit != "visit5", "no", "yes"))) %>% 
    mutate(wet_season = factor(wet_season, levels = c("no", "yes"))) %>% 
    filter(!is.na(num_domestic_water_containers_in_home)) %>% 
    mutate(how_often_use_bed_net = factor(
      how_often_use_bed_net,
      levels = c(
        "Never", 
        "Rarely", 
        "Most of the time", 
        "All of the time"
      )
    )) %>% 
    mutate(insecticide_spray = factor(insecticide_spray)) %>% 
    mutate(larvicide_applied_to_water = factor(larvicide_applied_to_water)) %>% 
    mutate(how_often_mosquito_coils_burned = factor(
      how_often_mosquito_coils_burned,
      levels = c(
        "Never", 
        "~ 1x/month", 
        "~ 1x/week",
        "~ 3x/week",
        "Daily"
      )
    ))
  
  
  aedes_red <- read_csv(here("data", "PAGODAS_Landtype.csv")) %>% 
    select(-c(X, Y, lon, lat, elevation)) %>% 
    clean_names() %>% 
    mutate(modal_land_type = factor(
      str_to_lower(modal_land_type), 
      levels = c("urban", "rice paddy", "cropland")
    )) %>% 
    right_join(aedes_red, by = "study_id")
  
  
  #### Incorporate satellite data
  max_date_diff <- 60
  date_lag <- params$modis_lag
  
  
  sat_data500 <- process_modis_data(
    df_og = read_csv(here("data", "MODIS_500m.csv"), show_col_types = FALSE), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 7
  ) %>% 
    arrange(Study.ID, var_type, date)
  
  
  sat_df <- sat_data500
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  
  for(i in 1:nrow(df_og)) {
    df_id <- sat_df %>% 
      filter(Study.ID == as.character(df_og[i, "study_id"]))
    
    for(j in 1:num_vars) {
      df_id_var <- df_id %>% 
        filter(var_type == var_types[j])
      
      if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
        date_diff <- (df_og$visit_date[i] - days(date_lag)) - df_id_var$date
        curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
        
        if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
          print(paste0(
            "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
            var_types[j], " value available within ", max_date_diff, 
            " days [max_date_diff] of ", date_lag, " days [date_lag] prior to visit date!"
          ))
        } else {
          df_new[i, var_types[j]] <- curr$sat_var_value
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI500_home = EVI, NVI500_home = NVI, NFI500_home = NFI)
  
  
  #### Incorporate satellite data 
  sat_data250 <- process_modis_data(
    df_og = read_csv(here("data", "MODIS_250m.csv"), show_col_types = FALSE), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 7
  )
  
  
  sat_df <- sat_data250
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  
  for(i in 1:nrow(df_og)) {
    df_id <- sat_df %>% 
      filter(Study.ID == as.character(df_og[i, "study_id"]))
    
    for(j in 1:num_vars) {
      df_id_var <- df_id %>% 
        filter(var_type == var_types[j])
      
      if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
        date_diff <- (df_og$visit_date[i] - days(date_lag)) - df_id_var$date
        curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
        
        if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
          print(paste0(
            "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
            var_types[j], " value available within ", max_date_diff, 
            " days [max_date_diff] of ", date_lag, " days [date_lag] prior to visit date!"
          ))
        } else {
          df_new[i, var_types[j]] <- curr$sat_var_value
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI250_home = EVI, NVI250_home = NVI, NFI250_home = NFI)
  
  
    #### Incorporate satellite data 16 days
  sat_data250 <- process_modis_data(
    df_og = read_csv(here("data", "MODIS_250m.csv"), show_col_types = FALSE), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 7
  )
  
  
  sat_df <- sat_data250
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  
  for(i in 1:nrow(df_og)) {
    df_id <- sat_df %>% 
      filter(Study.ID == as.character(df_og[i, "study_id"]))
    
    for(j in 1:num_vars) {
      df_id_var <- df_id %>% 
        filter(var_type == var_types[j])
      
      if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
        date_diff <- (df_og$visit_date[i] - days(16)) - df_id_var$date
        curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
        
        if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
          print(paste0(
            "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
            var_types[j], " value available within ", max_date_diff, 
            " days [max_date_diff] of ", 16, " days [16] prior to visit date!"
          ))
        } else {
          df_new[i, var_types[j]] <- curr$sat_var_value
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI250_home16 = EVI, NVI250_home16 = NVI, NFI250_home16 = NFI)
  
  
      #### Incorporate satellite data 48 days
  sat_data250 <- process_modis_data(
    df_og = read_csv(here("data", "MODIS_250m.csv"), show_col_types = FALSE), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 7
  )
  
  
  sat_df <- sat_data250
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  
  for(i in 1:nrow(df_og)) {
    df_id <- sat_df %>% 
      filter(Study.ID == as.character(df_og[i, "study_id"]))
    
    for(j in 1:num_vars) {
      df_id_var <- df_id %>% 
        filter(var_type == var_types[j])
      
      if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
        date_diff <- (df_og$visit_date[i] - days(48)) - df_id_var$date
        curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
        
        if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
          print(paste0(
            "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
            var_types[j], " value available within ", max_date_diff, 
            " days [max_date_diff] of ", 48, " days [48] prior to visit date!"
          ))
        } else {
          df_new[i, var_types[j]] <- curr$sat_var_value
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI250_home48 = EVI, NVI250_home48 = NVI, NFI250_home48 = NFI)
  
  
  #### Incorporate school satellite data 
  sat_data250 <- process_modis_data(
    df_og = read_csv(here("data", "SchoolsMODIS_250m.csv"), show_col_types = FALSE), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 6
  ) %>% 
    mutate(names = ifelse(
      names == "Kindergarten<U+200B> Salon", 
      yes = "Kindergarten​ Salon", 
      no = names
    ))
  
  
  sat_df <- sat_data250
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  
  for(i in 1:nrow(df_og)) {
    if(df_og[i, "school_attended_all"] != "Subject Not In School") {
      df_id <- sat_df %>% 
        filter(names == as.character(df_og[i, "school_attended_all"]))
      
      for(j in 1:num_vars) {
        df_id_var <- df_id %>% 
          filter(var_type == var_types[j])
        
        if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
          date_diff <- (df_og$visit_date[i] - days(date_lag)) - df_id_var$date
          curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
          
          if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
            print(paste0(
              "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
              var_types[j], " value available within ", max_date_diff, 
              " days [max_date_diff] of ", date_lag, " days [date_lag] prior to visit date!"
            ))
          } else {
            df_new[i, var_types[j]] <- curr$sat_var_value
          }
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI250_sch = EVI, NVI250_sch = NVI, NFI250_sch = NFI) %>% 
    mutate(EVI250_sch = ifelse(is.na(EVI250_sch), yes = 0, no = EVI250_sch)) %>% 
    mutate(NVI250_sch = ifelse(is.na(NVI250_sch), yes = 0, no = NVI250_sch)) %>% 
    mutate(NFI250_sch = ifelse(is.na(NFI250_sch), yes = 0, no = NFI250_sch))                 
  
  aedes_red <- aedes_red[!is.na(aedes_red$NVI250_home), ]
  
  
   #### Incorporate school satellite data 16
  sat_data250 <- process_modis_data(
    df_og = read_csv(here("data", "SchoolsMODIS_250m.csv"), show_col_types = FALSE), 
    sat_var_names = c("EVI", "NVI", "NFI"), # keep order that it appear in df
    sat_var_col_start = 6
  ) %>% 
    mutate(names = ifelse(
      names == "Kindergarten<U+200B> Salon", 
      yes = "Kindergarten​ Salon", 
      no = names
    ))
  
  
  sat_df <- sat_data250
  df_og <- aedes_red
  df_new <- cbind(
    df_og, 
    "EVI" = rep(NA, nrow(df_og)),
    "NFI" = rep(NA, nrow(df_og)),
    "NVI" = rep(NA, nrow(df_og))
  )
  
  num_vars <- 3
  var_types <- levels(factor(sat_df$var_type))
  
  
  for(i in 1:nrow(df_og)) {
    if(df_og[i, "school_attended_all"] != "Subject Not In School") {
      df_id <- sat_df %>% 
        filter(names == as.character(df_og[i, "school_attended_all"]))
      
      for(j in 1:num_vars) {
        df_id_var <- df_id %>% 
          filter(var_type == var_types[j])
        
        if (sum(!is.na(df_id_var$sat_var_value)) > 0) {
          date_diff <- (df_og$visit_date[i] - days(16)) - df_id_var$date
          curr <- df_id_var[which.min(ifelse(date_diff < 0, 1000, date_diff)), ]
          
          if (abs(curr$date - df_og$visit_date[i]) > max_date_diff) {
            print(paste0(
              "Warning: Study ID ", df_og[i, "study_id"], " does not have ", 
              var_types[j], " value available within ", max_date_diff, 
              " days [max_date_diff] of ", 16, " days [16] prior to visit date!"
            ))
          } else {
            df_new[i, var_types[j]] <- curr$sat_var_value
          }
        }
      }
    }
  }
  
  aedes_red <- df_new %>% 
    rename(EVI250_sch16 = EVI, NVI250_sch16 = NVI, NFI250_sch16 = NFI) %>% 
    mutate(EVI250_sch16 = ifelse(is.na(EVI250_sch16), yes = 0, no = EVI250_sch16)) %>% 
    mutate(NVI250_sch16 = ifelse(is.na(NVI250_sch16), yes = 0, no = NVI250_sch16)) %>% 
    mutate(NFI250_sch16 = ifelse(is.na(NFI250_sch16), yes = 0, no = NFI250_sch16))                 
  
  
  aedes_red <- aedes_red %>% 
    mutate(lat_s = (lat - mean(lat)) / sd(lat)) %>% 
    mutate(lon_s = (lon - mean(lon)) / sd(lon)) %>% 
    mutate(time = as.numeric(case_when(
      visit == "visit1" ~ 1,
      visit == "visit2" ~ 2,
      visit == "visit3" ~ 3,
      visit == "visit4" ~ 4,
      visit == "visit5" ~ 5
    ))) %>% 
    mutate(visit_year_cat = factor(as.character(visit_year), levels = c("0", "1", "2")))
  
  
  saveRDS(aedes_red, file = here("data", "processed_aedes_data.rds"))
  
} else { 
  aedes_red <- readRDS(file = here("data", "processed_aedes_data.rds")) 
}
  

aedes_red_ind <- aedes_red %>%
  filter(visit == "visit1") %>% 
  mutate(visit = droplevels(visit))
```


## Individual visit surfaces  
```{r prep_and_fit_visit_surf_model_func}
prep_and_fit_visit_surf_model <- function(data = aedes_red, visit_name, mesh_to_grid_dims){
  grid_dims_prod <- mesh_to_grid_dims[1] * mesh_to_grid_dims[2]
  
  
  ## extract relevant data (not sure if sorting is necessary)
  coords_st <- data %>% 
    arrange(study_id) %>% 
    filter(visit == visit_name) %>% 
    select(
      lon = x, lat = y, 
      log_saliva_elisa,
    )
    
  ## specify df of covariate values including intercept
  covar_df <- data.frame(
    Intercept = rep(1, nrow(coords_st)),
    select(coords_st, -c(lon, lat, log_saliva_elisa))
  )
      
  ## extract coordinates as matrix, ignoring repeats
  coords <- select(coords_st, lon, lat) %>% 
    distinct() %>% 
    as.matrix()
    
  ## create mesh, good documentation available to understand all options
  mesh <- inla.mesh.2d(
    loc = coords,
    max.edge = c(300, 600)
  )
    
    
  ## specify spde
  spde <- inla.spde2.matern(mesh)
    
  # Need to specify index with spde and group (if there are replicates)
  s.index <- inla.spde.make.index(
    "spatial.field", 
    n.spde = spde$n.spde,
    n.group = 1
  )
    
  ## A specifies something about edge length based on the mesh
  A <- inla.spde.make.A(
    mesh = mesh, 
    loc = as.matrix(select(coords_st, lon, lat))
  )
    
  ## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index. 
  data_stack <- inla.stack(
    data = list(y = coords_st$log_saliva_elisa),
    A = list(A, 1),
    effects = list(s.index, list(covar_df = covar_df)),
    tag = "est"
  )
    
    
  ## specify model formula, 'f()' incorporates spatial effect and replicate 
  formula <- y ~ 0 + Intercept +
    f(
      spatial.field, 
      model = spde
    )
      
    
  ## fixed effect priors
  coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
  )
    
    
  ## This is with a grid
  proj_grid <- inla.mesh.projector(
    mesh, 
    # xlim = range(mesh$loc[, 1]), 
    # ylim = range(mesh$loc[, 2]),
    dims = mesh_to_grid_dims
  )
    
  pred_stack <- inla.stack(
    data = list(y = NA),
    A = list(proj_grid$proj$A, 1),
    effects = list(
      s.index, 
      Intercept = rep(1, grid_dims_prod)
    ),
    tag = "pred"
  )
    
    
  full_stack <- inla.stack(data_stack, pred_stack)
    
    
  ## Fit model
  visit_fit <- inla(
    formula, 
    data = inla.stack.data(full_stack),
    control.predictor = list(A = inla.stack.A(full_stack), compute = TRUE),
    control.fixed = coeff_priors,
    control.results = list(
      return.marginals.random = FALSE,
      return.marginals.predictor = TRUE
    )
  )
    
    
  ## Extract indices of observations predictions were made for
  pred_index <- inla.stack.index(full_stack, "pred")$data
    
    
  ## Extract prediction means, sd, and 0.025 and 0.975 quantiles
  visit_preds <- visit_fit$summary.fitted.values[pred_index, c(1:3, 5)]
  
  
  preds_df <- bind_rows(
    data.frame(proj_grid$lattice$loc, "pred" = visit_preds$`0.025quant`) %>% 
      select(lon = X1, lat = X2, pred) %>% 
      mutate(type = rep("ci_lb0.025", grid_dims_prod)),
    data.frame(proj_grid$lattice$loc, "pred" = visit_preds$`0.975quant`) %>% 
        select(lon = X1, lat = X2, pred) %>% 
        mutate(type = rep("ci_ub0.975", grid_dims_prod)),
    data.frame(proj_grid$lattice$loc, "pred" = visit_preds$mean) %>% 
      select(lon = X1, lat = X2, pred) %>% 
      mutate(type = rep("mean", grid_dims_prod))
  ) %>% 
    mutate(type = factor(type, levels = c("ci_lb0.025", "mean", "ci_ub0.975")))
  
  
  list("visit_fit" = visit_fit, "preds_df" = preds_df)
}
```


```{r ind-visit-surf-fit}
if(params$refit_vistit_fit) {
  
  v1_fit <- prep_and_fit_visit_surf_model(
    visit_name = "visit1", 
    mesh_to_grid_dims = c(101, 101)
  )
  
   v2_fit <- prep_and_fit_visit_surf_model(
    visit_name = "visit2",
    mesh_to_grid_dims = c(101, 101)
  )
  
   v3_fit <- prep_and_fit_visit_surf_model(
    visit_name = "visit3",
    mesh_to_grid_dims = c(101, 101)
  )
   
  v4_fit <- prep_and_fit_visit_surf_model(
    visit_name = "visit4",
    mesh_to_grid_dims = c(101, 101)
  )
  
  v5_fit <- prep_and_fit_visit_surf_model(
    visit_name = "visit5",
    mesh_to_grid_dims = c(101, 101)
  )
  
  ind_visit_surf_df_og <- rbind(
  cbind(v1_fit$preds_df, "visit" = rep("Visit 1", nrow(v1_fit$preds_df))), 
  cbind(v2_fit$preds_df, "visit" = rep("Visit 2", nrow(v2_fit$preds_df))), 
  cbind(v3_fit$preds_df, "visit" = rep("Visit 3", nrow(v3_fit$preds_df))), 
  cbind(v4_fit$preds_df, "visit" = rep("Visit 4", nrow(v4_fit$preds_df))), 
  cbind(v5_fit$preds_df, "visit" = rep("Visit 5", nrow(v5_fit$preds_df)))
) %>% 
  mutate(type = factor(
    case_when(
      type == "ci_lb0.025" ~ "CI 95% LB", 
      type == "mean" ~ "Mean",
      type == "ci_ub0.975" ~ "CI 95% UB"
    ),
    levels = c("CI 95% LB", "Mean", "CI 95% UB")
  )) %>% 
  mutate(Prediction = pred) %>% 
  mutate(x_m = lon) %>%
  mutate(y_m = lat) %>% 
  select(-c("pred", "lon", "lat"))
  
  
  ## Get UTMs from coordinates
  utm_ex <- SpatialPoints(
    as.matrix(select(ind_visit_surf_df_og, x_m, y_m)),
    proj4string = CRS("+proj=utm +zone=48")
  )
  
  lat_lon <- coordinates(spTransform(utm_ex, CRS("+proj=longlat")))
  
  ind_visit_surf_df <- data.frame(
    ind_visit_surf_df_og,
    lon = lat_lon[, "x_m"],
    lat = lat_lon[, "y_m"]
  )
  
  
  saveRDS(ind_visit_surf_df, here("output", "ind_visit_surf_df.rds"))
  
} else {
  
  ind_visit_surf_df <- readRDS(here("output", "ind_visit_surf_df.rds"))
  
}

fit_y <- lm(y_m ~ lat, data = ind_visit_surf_df)

y_coef <- as.vector(fit_y$coefficients)

lat_labels <- c(11.45, 11.46, 11.47)

lat_breaks <- c(
  y_coef[1] + y_coef[2] * lat_labels[1], 
  y_coef[1] + y_coef[2] * lat_labels[2], 
  y_coef[1] + y_coef[2] * lat_labels[3]
)

fit_x <- lm(x_m ~ lon, data = ind_visit_surf_df)

x_coef <- as.vector(fit_x$coefficients)

lon_labels <- c(104.51, 104.53, 104.55)

lon_breaks <- c(
  x_coef[1] + x_coef[2] * lon_labels[1], 
  x_coef[1] + x_coef[2] * lon_labels[2], 
  x_coef[1] + x_coef[2] * lon_labels[3]
)
```


```{r google-map, eval = FALSE}
sat_map <- get_googlemap(center = c(lon = 104.53, lat = 11.46), maptype = "terrain")
```


```{r plot_visit_predictions-without-cis}
pdf(here("output", "visit-prediction-surfaces-wo-ci.pdf"), width = 10)

ind_visit_surf_df %>% 
  filter(type == "Mean") %>% 
  filter(visit != "Visit 5") %>% 
  filter(x_m >= x_coef[1] + x_coef[2] * 104.50 & x_m <= x_coef[1] + x_coef[2] * 104.56) %>% 
  filter(y_m >= y_coef[1] + y_coef[2] * 11.44 & y_m <= y_coef[1] + y_coef[2] * 11.48) %>% 
ggplot() +
  geom_raster(mapping = aes(x = x_m, y = y_m, fill = Prediction)) +
  facet_grid(~ visit) +
  coord_equal() +
  scale_fill_viridis() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw() +
  theme(
    strip.background = element_rect(fill = NA),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "white"),
    panel.background = element_rect(fill = NA),
    panel.ontop = TRUE,
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_y_continuous(breaks = lat_breaks, labels = lat_labels) +
  scale_x_continuous(breaks = lon_breaks, labels = lon_labels)

dev.off()
```


```{r plot_visit_predictions-with-cis}
pdf(here("output", "visit-prediction-surfaces-w-ci.pdf"), width = 10)

ind_visit_surf_df %>% 
  filter(visit != "Visit 5") %>% 
  filter(x_m >= x_coef[1] + x_coef[2] * 104.50 & x_m <= x_coef[1] + x_coef[2] * 104.56) %>% 
  filter(y_m >= y_coef[1] + y_coef[2] * 11.44 & y_m <= y_coef[1] + y_coef[2] * 11.48) %>% 
ggplot() +
  geom_raster(mapping = aes(x = x_m, y = y_m, fill = Prediction)) +
  facet_grid(type ~ visit) +
  coord_equal() +
  scale_fill_viridis() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw() +
  theme(
    strip.background = element_rect(fill = NA),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "white"),
    panel.background = element_rect(fill = NA),
    panel.ontop = TRUE,
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +
  scale_y_continuous(breaks = lat_breaks, labels = lat_labels) +
  scale_x_continuous(breaks = lon_breaks, labels = lon_labels)

dev.off()
```


```{r display-visit-prediction-surfaces-wo-v5-plot, eval = TRUE, fig.align='center', out.width='100%', fig.cap='Prediction surfaces of mean Aedes mosquito exposure by visit, without visit 5.'}
knitr::include_graphics(here("output", "visit-prediction-surfaces-wo-v5.pdf"))
```



\newpage 

## Main model
Full model equation:

\begin{equation*}
  \begin{split}
    \log(\text{Saliva antibody response})_{ij} &= \beta_0 + \boldsymbol{\beta} *(\\
    &\text{Gender}_i + \text{Age}_i  + \text{Distance to river}_i + \text{Land type}_i\\
    &+\text{Toilets}_i + \text{Water containers}_i + \text{Insecticide}_i + \text{Larval containers}_i\\
    &+ \text{NFI}_{ij} + \text{Wet season}_{ij})
  \end{split}
\end{equation*}

`Gender` Indicator for gender (female and male only)  
`Age` Baseline age centered at 7 years old  
`Land type` This is the modal land type across *?* pixels around house; has 3 levels: "urban", "rice paddy", "cropland".  
`Distance to river` Distance in meters from house to nearest part of the stream; centered and scaled  
`Insecticide` Indicator for use of insecticide spray  
`Larvicide` Indicator for use of larvicide spray applied to water  
`Toilets` Number of toilets in house  
`Water containers` Number of domestic water containers in house  
`Wet season` Indicator for visit date being in wet season  
`NFI` Mean flooding index for a 250 meter buffer around house 32 days prior to visit date


```{r main-model-prep-wov5}
## extract relevant data (not sure if sorting is necessary)
coords_st <- aedes_red %>% 
  filter(visit != "visit5") %>% 
  arrange(study_id, time) %>% 
  select(
    time, 
    lon = x, lat = y, 
    log_saliva_elisa,
    gender,
    age_cented7, distance_to_river_scaled,
    modal_land_type,
    num_toilets_in_home, num_domestic_water_containers_in_home,
    insecticide_spray, larvicide_applied_to_water,
    NFI250_home,
    wet_season
  )

## specify df of covariate values including intercept
covar_df <- data.frame(
  # Intercept = rep(1, nrow(coords_st)),
  select(coords_st, -c(time, lon, lat, log_saliva_elisa))
)
  
## extract coordinates as matrix, ignoring repeats
coords <- select(coords_st, lon, lat) %>% 
  distinct() %>% 
  as.matrix()

## create mesh, good documentation available to understand all options
mesh <- inla.mesh.2d(
  loc = coords,
  max.edge = c(300, 600)
)

# specify spde
spde <- inla.spde2.matern(mesh)

# Need to specify index with spde and group (if there are replicates)
s.index <- inla.spde.make.index(
  "spatial.field", 
  n.spde = spde$n.spde,
  n.group = 4
)

## A specifies something about edge length based on the mesh
A <- inla.spde.make.A(
  mesh = mesh, 
  loc = as.matrix(select(coords_st, lon, lat)), 
  group = coords_st$time
)

## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
stack <- inla.stack(
  data = list(y = coords_st$log_saliva_elisa),
  A = list(A, 1),
  effects = list(
    s.index,
    list(covar_df = covar_df)
  ),
  tag = "est"
)

## specify model formula, 'f()' incorporates spatial effect and replicate 
formula <- y ~ #0 + Intercept
  gender + 
  age_cented7  + distance_to_river_scaled +
  modal_land_type +
  num_toilets_in_home + num_domestic_water_containers_in_home +
  insecticide_spray + larvicide_applied_to_water  +
  NFI250_home  +
  wet_season +
  f(
    spatial.field, 
    model = spde, 
    group = spatial.field.group, 
    control.group = list(model = "iid")
  )
  

## fixed effect priors
coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
)
```


```{r main-model-wov5}
if(params$refit_fit) {
  main_fit_wov5 <- inla(
    formula, 
    data = inla.stack.data(stack),
    control.predictor = list(
      A = inla.stack.A(stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )
  
  # Warning in inla(formula, data = inla.stack.data(stack), control.predictor = list(A = inla.stack.A(stack)),  :
  # The A-matrix in the predictor (see ?control.predictor) is specified
  # but an intercept is in the formula. This will likely result
  # in the intercept being applied multiple times in the model, and is likely
  # not what you want. See ?inla.stack for more information.
  # You can remove the intercept adding ``-1'' to the formula.
  
  saveRDS(main_fit_wov5, here("output", "main-fit_wov5.rds"))
} else {
  main_fit_wov5 <- readRDS(here("output", "main-fit_wov5.rds"))
}
```


```{r}
ggplot_inla_residuals2(
  main_fit_wov5, 
  coords_st$log_saliva_elisa, 
  se = FALSE
)
```


```{r main-summary-wov5}
summary(main_fit_wov5)
```


```{r Spatial-field-visualization}
gproj <- inla.mesh.projector(mesh)


gen_spatial_field_plots <- function(visit_num, plot_mean = TRUE){
  if(plot_mean){
    inla.mesh.project(
      gproj, 
      main_fit_wov5$summary.random$spatial.field$mean[s.index$spatial.field.group == visit_num]
    )
  } else {
    inla.mesh.project(
      gproj, 
      main_fit_wov5$summary.random$spatial.field$sd[s.index$spatial.field.group == visit_num]
    )
  }
}


grid.arrange(
  levelplot(
    gen_spatial_field_plots(1), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 1 mean',col.regions = viridis(16)
  ), 
  levelplot(
    gen_spatial_field_plots(2), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 2 mean',col.regions = viridis(16)
  ),
  levelplot(
    gen_spatial_field_plots(3), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 3 mean',col.regions = viridis(16)
  ),
  levelplot(
    gen_spatial_field_plots(4), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 4 mean',col.regions = viridis(16)
  ),
  nrow=2
)

grid.arrange(
  levelplot(
    gen_spatial_field_plots(1, plot_mean = FALSE), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 1 sd',col.regions = viridis(16)
  ), 
  levelplot(
    gen_spatial_field_plots(2, plot_mean = FALSE), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 2 sd',col.regions = viridis(16)
  ), 
  levelplot(
    gen_spatial_field_plots(3, plot_mean = FALSE), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 3 sd',col.regions = viridis(16)
  ),
  levelplot(
    gen_spatial_field_plots(4, plot_mean = FALSE), 
    scales=list(draw=F), xlab='', ylab='', main='Visit 4 sd',col.regions = viridis(16)
  ), 
  nrow=2
)
```


```{r}
g_mean <- inla.mesh.project(
  gproj, 
  main_fit_wov5$summary.random$spatial.field$mean[s.index$spatial.field.group == visit_num]
)
g_sd <- inla.mesh.project(
  gproj, 
  main_fit_wov5$summary.random$spatial.field$sd[s.index$spatial.field.group == visit_num]
)


grid.arrange(
  levelplot(g_mean, scales=list(draw=F), xlab='', ylab='', main='mean',col.regions = heat.colors(16)),
  levelplot(g_sd, scal=list(draw=F), xla='', yla='', main='sd' ,col.regions = heat.colors(16)), 
  nrow=1
)

```


```{r set-up-main-model-results-df}
## Check that pred_rownames and pred_name_vec line up
pred_rownames_ordered <- c(
  "(Intercept)",
  "genderMale",
  "age_cented7",
  "modal_land_typerice paddy",
  "modal_land_typecropland",
  "distance_to_river_scaled",
  "insecticide_sprayYes",
  "larvicide_applied_to_waterYes",
  "num_toilets_in_home",
  "num_domestic_water_containers_in_home",
  "NFI250_home",
  "wet_seasonyes"
)

pred_names_vec = c(
  "(Intercept)",
  "Male", 
  "Age", 
  "Rice paddy",
  "Cropland",
  "Distance to river", 
  "Insecticide",
  "Larvicide",
  "Toilets",
  "Water containers",
  "NFI",
  "Wet season"
)


main_fit_df <- main_fit_wov5$summary.fixed %>% 
  mutate(unordered_names = rownames(main_fit_wov5$summary.fixed)) %>% 
  mutate(pred_names = factor(
    unordered_names,
    levels = pred_rownames_ordered,
    labels = pred_names_vec
  )) %>% 
  select(quant025 = "0.025quant", mean = "mean", quant975 = "0.975quant", pred_names)
```


```{r main-model-table-data-prep}
total_n <- nrow(aedes_red_ind)

aedes_red_wo5 <- filter(aedes_red, visit != "visit5") %>% mutate(visit = droplevels(visit))
visit_n_df <- group_by(aedes_red_wo5, visit) %>% summarize(group_n = n())


## Visit 1 summary statistics
visit1_summary <- bind_rows(
  ## Gender
  aedes_red_ind %>% group_by(gender) %>% summarize(count_n = n()) %>% 
    mutate(variable1 = "Gender") %>% mutate(variable2 = gender) %>% 
    mutate(visit1 = paste0(
      count_n, " (", round(100 * count_n / total_n, 2), "%)")) %>% 
    select(variable1, variable2, visit1),
  ## Age
  data.frame(
    variable1 = " ", 
    variable2 = "Age",
    visit1 = paste0(
      round(mean(aedes_red_ind$age), 2), " (", round(sd(aedes_red_ind$age), 2), ")"
    )
  ),
  ## Land type
  aedes_red_ind %>% group_by(modal_land_type) %>% summarize(count_n = n()) %>% 
    mutate(variable1 = "Land type") %>% mutate(variable2 = modal_land_type) %>% 
    mutate(visit1 = paste0(
      count_n, " (", round(100 * count_n / total_n, 2), "%)"
    )) %>% 
    select(variable1, variable2, visit1),
  ## Distance to river
  data.frame(
    variable1 = " ", 
    variable2 = "Distance to river",
    visit1 = paste0(
      round(mean(aedes_red_ind$distance_to_river), 2), " (", round(sd(aedes_red_ind$distance_to_river), 2), ")"
    )
  )
) %>% 
  mutate(variable2 = str_to_sentence(variable2)) %>% 
  mutate(visit2 = "") %>% mutate(visit3 = "") %>% mutate(visit4 = "")


all_visits_summary <- bind_rows(
  ## Insecticide spray
  aedes_red_wo5 %>% 
    group_by(visit, insecticide_spray) %>% summarize(count_n = n()) %>% 
    left_join(visit_n_df) %>% 
    mutate(col_summary = paste0(
      count_n, " (", round(100 * count_n / group_n, 2), "%)"
    )) %>%
    mutate(variable1 = "Insecticide") %>% mutate(variable2 = insecticide_spray) %>% 
    select(variable1, variable2, visit, col_summary) %>% 
    pivot_wider(names_from = visit, values_from = col_summary, values_fill = ""),
  ## Larvicide spray
   aedes_red_wo5 %>% 
    group_by(visit, larvicide_applied_to_water) %>% summarize(count_n = n()) %>% 
    left_join(visit_n_df) %>% 
    mutate(col_summary = paste0(
      count_n, " (", round(100 * count_n / group_n, 2), "%)"
    )) %>%
    mutate(variable1 = "Larvicide") %>% mutate(variable2 = larvicide_applied_to_water) %>% 
    select(variable1, variable2, visit, col_summary) %>% 
    pivot_wider(names_from = visit, values_from = col_summary, values_fill = ""),
  ## Toilets
  aedes_red_wo5 %>% 
    group_by(visit) %>% 
    summarize(mean = mean(num_toilets_in_home), sd = sd(num_toilets_in_home)) %>% 
    mutate(col_summary = paste0(round(mean, 2), " (", round(sd, 2), ")")) %>% 
    mutate(variable1 = "") %>% mutate(variable2 = "Toilets") %>% 
    select(variable1, variable2, visit, col_summary) %>% 
    pivot_wider(names_from = visit, values_from = col_summary, values_fill = ""),
  ## Water containers
  aedes_red_wo5 %>% 
    group_by(visit) %>% 
    summarize(mean = mean(num_domestic_water_containers_in_home), sd = sd(num_domestic_water_containers_in_home)) %>% 
    mutate(col_summary = paste0(round(mean, 2), " (", round(sd, 2), ")")) %>% 
    mutate(variable1 = "") %>% mutate(variable2 = "Water containers") %>% 
    select(variable1, variable2, visit, col_summary) %>% 
    pivot_wider(names_from = visit, values_from = col_summary, values_fill = ""),
  ## NFI
  aedes_red_wo5 %>% 
    group_by(visit) %>% 
    summarize(mean = mean(NFI250_home), sd = sd(NFI250_home)) %>% 
    mutate(col_summary = paste0(round(mean, 2), " (", round(sd, 2), ")")) %>% 
    mutate(variable1 = "") %>% mutate(variable2 = "NFI") %>% 
    select(variable1, variable2, visit, col_summary) %>% 
    pivot_wider(names_from = visit, values_from = col_summary, values_fill = "")
)
  


main_est <- main_fit_df %>% 
  filter(pred_names != "(Intercept)") %>% 
  mutate(Estimate = paste0(
    round(mean, 3), " (", round(quant025, 3 ), ", ", round(quant975, 3), ")"
  ))

main_est1 <- main_est[order(main_est$pred_names, pred_names_vec[-1]), ]

main_results_table <- bind_rows(visit1_summary, all_visits_summary) %>% 
  bind_rows(data.frame(
    variable1 = rep("Wet season", 2),
    variable2 = c("No", "Yes"),
    visit1 = c("0", paste0(visit_n_df$group_n[1])),
    visit2 = c(paste0(visit_n_df$group_n[2]), "0"),
    visit3 = c("0", paste0(visit_n_df$group_n[3])),
    visit4 = c(paste0(visit_n_df$group_n[4]), "0")
  )) %>% 
  mutate(Estimate = "Reference")

main_results_table$Estimate[c(2:3, 5:7, 9, 11:14, 16)] <- main_est1$Estimate

saveRDS(main_results_table, here("output", "main-model-results-table.RDS"))
```


```{r main-model-results-table, eval = TRUE}
main_results_table <- readRDS(here("output", "main-model-results-table.RDS"))

main_results_table %>% 
  select(-c("variable1")) %>% 
kbl(
  #booktabs = TRUE, 
  col.names = c(" ", "Visit 1", "Visit 2", "Visit 3", "Visit 4", "Mean Estimate (95% CI)")
) %>% 
  kable_styling() %>% 
  pack_rows(
    index = c(
      "Gender" = 2,
      " " = 1,
      "Land type" = 3,
      " " = 1,
      "Insecticide" = 2,
      "Larvicide" = 2,
      " " = 3,
      "Wet season" = 2
    ), 
    bold = FALSE
  )
```


\newpage
```{r main-model-forest-plot-wov5}
pdf(here("output", "main-model-forest-plot-wo-v5.pdf"))

main_fit_df %>% 
  filter(pred_names != "(Intercept)") %>% 
  ggplot(aes(x = mean, y = pred_names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("") +
  scale_y_discrete(limits = rev)

dev.off()
```

```{r load-main-model-forest-plot-wov5, eval = TRUE, fig.cap="Full model results without visit 5"}
include_graphics(here("output", "main-model-forest-plot-wo-v5.pdf"))
```



\newpage
## Larval models  
- The house hold survey data contains the `container index` which is the # of water containers that contained larvae in a house. This survey has different sampling units, and only has measurements around the times of visits 1 through 4.
- The Aedes serology individual's houses were matched to nearest `container index`, within a 300 meter radius. This subsetting is visualized in plots below.
- The same predictors from the full model were used in addition to this new larval predictor named `larval %`, and without the visit 5 predictor, to model log exposure as before


\newpage
```{r larval-data-match}
aedes_larval_red_og <- aedes_red %>% 
  filter(visit != "visit5") %>% 
  mutate(visit = droplevels(visit))

#### Incorporate larval data
larval_lat_lo <- read_csv(here("data", "HH_Surveys_19Jan_UTM48N.csv"), show_col_types = FALSE) %>% 
  select(
    larval_X = "X...1",
    larval_Y = "Y...2",
    larval_lon = "X...3",
    larval_lat = "Y...4",
    house_num = "name",
    subj_id = "SUBJID"
  ) %>% 
  mutate(subj_id = as.character(as.numeric(subj_id))) %>% 
  filter(!duplicated(subj_id)) #subjects 389 and 716 had repeat measurements; 1st kept
    
  
larval_hs <- read_xlsx(here("data", "House Survey Data_Extracted 03May2021.xlsx")) %>%
  select(
    subj_id = SUBJID,
    water_containers_og = WATERCON,
    water_larvae = WATERLARVAE,
    visit_year = Year,
    visit_month = Month
  ) %>% 
  mutate(subj_id = as.character(subj_id)) %>% 
  filter(!is.na(visit_year)) %>% 
  mutate(visit_date = ym(paste(visit_year, visit_month))) %>% 
  mutate(visit = factor(case_when(
    visit_year == 2018 & visit_month >= 5 & visit_month <= 9 ~ "visit1",
    visit_year == 2019 & !(visit_month >= 5 & visit_month <= 9) ~ "visit2",
    visit_year == 2019 & visit_month >= 5 & visit_month <= 9 ~ "visit3",
    visit_year == 2020 & !(visit_month >= 5 & visit_month <= 9) ~ "visit4"
  ))) %>% 
  mutate(water_containers = ifelse(
    water_containers_og == "*", 
    99999,
    as.numeric(water_containers_og))) %>% 
  filter(water_containers != 9999) %>% 
  mutate(container_index = ifelse(
    water_containers != 0,
      as.numeric(water_larvae) / as.numeric(water_containers),
    0
  )) %>% 
  mutate(con_w_larvae = as.numeric(water_larvae)) %>% 
  left_join(y = larval_lat_lo) 

  
## Match nearest larval count to aedes data
aedes_larval_red <- aedes_larval_red_og
aedes_larval_red$ave_larv_cont <- NA
aedes_l_red <- NA


for(v in levels(aedes_larval_red$visit)) {
  larval_hs_red <- filter(larval_hs, visit == v)
  larval_coord <- as.matrix(select(larval_hs_red, larval_X, larval_Y))
    
  aedes_larval_red <- filter(aedes_larval_red_og, visit == v)
  
  curr_nrow <- nrow(aedes_larval_red)
    
  for(i in 1:curr_nrow){
    id_coord <- as.matrix(aedes_larval_red[i, c("x", "y")])

    dists <- sqrt((id_coord[1] - larval_coord[, 1])^2 + (id_coord[2] - larval_coord[, 2])^2)
    
    if(sum(dists <= 250) > 0) {
      aedes_larval_red$ave_larv_cont[i] <- mean(larval_hs_red$con_w_larvae[dists <= 250])
    } else {
      aedes_larval_red$ave_larv_cont[i] <- NA
    }
  }
  
  if(v == "visit1") {
    aedes_l_red <- aedes_larval_red
  } else {
    aedes_l_red <- bind_rows(aedes_l_red, aedes_larval_red)
  }
}

aedes_red_w_larval <- aedes_l_red %>% 
  arrange(study_id, visit)
```


```{r plot-showing-larval-subsetting}
pdf(here("output", "larval-subsetting-plot1.pdf"), width = 10)

aedes_red_w_larval %>% 
    mutate(Larvae = ave_larv_cont) %>% 
    ggplot(aes(x = x, y = y, color = Larvae)) +
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_red_w_larval$x)) +
      ylim(range(aedes_red_w_larval$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched")
  
dev.off()


pdf(here("output", "larval-subsetting-plot2.pdf"), width = 10)

  aedes_red_w_larval %>% 
    filter(!is.na(ave_larv_cont)) %>% 
    mutate(Larvae = ave_larv_cont) %>% 
    ggplot(aes(x = x, y = y, color = Larvae))+
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_red_w_larval$x)) +
      ylim(range(aedes_red_w_larval$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched reduced")
  
dev.off()


pdf(here("output", "larval-subsetting-plot3.pdf"), width = 10)

  larval_hs %>% 
    mutate(Larvae = con_w_larvae) %>% 
    ggplot(aes(x = larval_X, y = larval_Y, color = Larvae)) +
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_red_w_larval$x)) +
      ylim(range(aedes_red_w_larval$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Larval data")
  


dev.off()
```


```{r load-larval-subsetting-plot3, eval = TRUE}
include_graphics(here("output", "larval-subsetting-plot3.pdf"))
```

```{r load-larval-subsetting-plot1, eval = TRUE}
include_graphics(here("output", "larval-subsetting-plot1.pdf"))
```

```{r load-larval-subsetting-plot2, eval = TRUE}
include_graphics(here("output", "larval-subsetting-plot2.pdf"))
```


```{r saliva-vs-larvae}
ggplot(aedes_red_w_larval, aes(x = ave_larv_cont, y = log_saliva_elisa)) +
  geom_point() +
  xlab("Average number of water containers with larae found in 250m radius") +
  theme_bw()
```


### Added containters with larvae as predictor
```{r larval-model-prep}
## extract relevant data (not sure if sorting is necessary)
coords_st <- aedes_red_w_larval %>% 
  filter(!is.na(ave_larv_cont)) %>% 
  arrange(study_id, time) %>% 
  select(
    time, 
    lon = x, lat = y, 
    log_saliva_elisa,
    gender,
    age_cented7, distance_to_river_scaled,
    modal_land_type,
    num_toilets_in_home, num_domestic_water_containers_in_home,
    insecticide_spray, larvicide_applied_to_water,
    NFI250_home,
    wet_season,
    ave_larv_cont
    )

## specify df of covariate values including intercept
covar_df <- data.frame(
  # Intercept = rep(1, nrow(coords_st)),
  select(coords_st, -c(time, lon, lat, log_saliva_elisa))
)
  
## extract coordinates as matrix, ignoring repeats
coords <- select(coords_st, lon, lat) %>% 
  distinct() %>% 
  as.matrix()

## create mesh, good documentation available to understand all options
mesh <- inla.mesh.2d(
  loc = coords,
  max.edge = c(300, 600)
)

# specify spde
spde <- inla.spde2.matern(mesh)

# Need to specify index with spde and group (if there are replicates)
s.index <- inla.spde.make.index(
  "spatial.field", 
  n.spde = spde$n.spde,
  n.group = 4
)

## A specifies something about edge length based on the mesh
A <- inla.spde.make.A(
  mesh = mesh, 
  loc = as.matrix(select(coords_st, lon, lat)), 
  group = coords_st$time
)

## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
stack <- inla.stack(
  data = list(y = coords_st$log_saliva_elisa),
  A = list(A, 1),
  effects = list(
    s.index,
    list(covar_df = covar_df)
  ),
  tag = "est"
)

## specify model formula, 'f()' incorporates spatial effect and replicate 
formula <- y ~ #0 + Intercept
  gender + 
  age_cented7  + distance_to_river_scaled +
  modal_land_type +
  num_toilets_in_home + num_domestic_water_containers_in_home +
  insecticide_spray + larvicide_applied_to_water  +
  NFI250_home  +
  wet_season +
  ave_larv_cont +
  f(
    spatial.field, 
    model = spde, 
    group = spatial.field.group, 
    control.group = list(model = "iid")
  )
  

## fixed effect priors
coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
)
```


```{r larval-model-fit}
if(params$refit_larval_fit) {
  larval_fit <- inla(
    formula, 
    data = inla.stack.data(stack),
    control.predictor = list(
      A = inla.stack.A(stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )

  # Warning in inla(formula, data = inla.stack.data(stack), control.predictor = list(A = inla.stack.A(stack)),  :
  # The A-matrix in the predictor (see ?control.predictor) is specified
  # but an intercept is in the formula. This will likely result
  # in the intercept being applied multiple times in the model, and is likely
  # not what you want. See ?inla.stack for more information.
  # You can remove the intercept adding ``-1'' to the formula.
  
  saveRDS(larval_fit, here("output", "larval_fit.rds"))
} else {
  larval_fit <- readRDS(here("output", "larval_fit.rds"))
}
```


```{r larval-model-summary}
summary(larval_fit)
```


```{r larval-model-forest_plot}
larval_fit_df <- larval_fit$summary.fixed %>% 
  mutate(unordered_names = rownames(larval_fit$summary.fixed)) %>% 
  mutate(pred_names = factor(
    unordered_names,
    levels = c(pred_rownames_ordered, "ave_larv_cont"),
    labels = c(pred_names_vec, "Larval containers")
  )) %>% 
  select(quant025 = "0.025quant", mean = "mean", quant975 = "0.975quant", pred_names) 

    
pdf(here("output", "larval-model-forest-plot.pdf"))

larval_fit_df %>% 
  filter(pred_names != "(Intercept)") %>% 
  ggplot(aes(x = mean, y = pred_names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("") +
  scale_y_discrete(limits = rev)

dev.off()
```


```{r load-larval-model-forest-plot, eval = TRUE, fig.cap="Full model results with larvae containg water containers added."}
include_graphics(here("output", "larval-model-forest-plot.pdf"))
```


### Containters with larvae as response
```{r larval-res-model-prep}
## extract relevant data (not sure if sorting is necessary)
coords_st <- aedes_red_w_larval %>% 
  filter(!is.na(ave_larv_cont)) %>% 
  arrange(study_id, time) %>% 
  select(
    time, 
    lon = x, lat = y, 
    distance_to_river_scaled,
    modal_land_type,
    num_toilets_in_home, num_domestic_water_containers_in_home,
    insecticide_spray, larvicide_applied_to_water,
    NFI250_home,
    wet_season,
    ave_larv_cont
    )

## specify df of covariate values including intercept
covar_df <- data.frame(
  # Intercept = rep(1, nrow(coords_st)),
  select(coords_st, -c(time, lon, lat, ave_larv_cont))
)
  
## extract coordinates as matrix, ignoring repeats
coords <- select(coords_st, lon, lat) %>% 
  distinct() %>% 
  as.matrix()

## create mesh, good documentation available to understand all options
mesh <- inla.mesh.2d(
  loc = coords,
  max.edge = c(300, 600)
)

# specify spde
spde <- inla.spde2.matern(mesh)

# Need to specify index with spde and group (if there are replicates)
s.index <- inla.spde.make.index(
  "spatial.field", 
  n.spde = spde$n.spde,
  n.group = 4
)

## A specifies something about edge length based on the mesh
A <- inla.spde.make.A(
  mesh = mesh, 
  loc = as.matrix(select(coords_st, lon, lat)), 
  group = coords_st$time
)

## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
stack <- inla.stack(
  data = list(y = coords_st$ave_larv_cont),
  A = list(A, 1),
  effects = list(
    s.index,
    list(covar_df = covar_df)
  ),
  tag = "est"
)

## specify model formula, 'f()' incorporates spatial effect and replicate 
formula <- y ~ #0 + Intercept
  distance_to_river_scaled +
  modal_land_type +
  num_toilets_in_home + num_domestic_water_containers_in_home +
  insecticide_spray + larvicide_applied_to_water  +
  NFI250_home  +
  wet_season +
  f(
    spatial.field, 
    model = spde, 
    group = spatial.field.group, 
    control.group = list(model = "iid")
  )
  

## fixed effect priors
coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
)
```


```{r larval-res-model-fit}
if(params$refit_larval_fit) {
  larval_res_fit <- inla(
    formula, 
    data = inla.stack.data(stack),
    control.predictor = list(
      A = inla.stack.A(stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )

  # Warning in inla(formula, data = inla.stack.data(stack), control.predictor = list(A = inla.stack.A(stack)),  :
  # The A-matrix in the predictor (see ?control.predictor) is specified
  # but an intercept is in the formula. This will likely result
  # in the intercept being applied multiple times in the model, and is likely
  # not what you want. See ?inla.stack for more information.
  # You can remove the intercept adding ``-1'' to the formula.
  
  saveRDS(larval_res_fit, here("output", "larval_res_fit.rds"))
} else {
  larval_res_fit <- readRDS(here("output", "larval_res_fit.rds"))
}
```


```{r}
ggplot_inla_residuals2(
  larval_res_fit, 
  coords_st$ave_larv_cont, 
  se = FALSE
) +
  theme_bw()
```


```{r larval-res-model-summary}
summary(larval_res_fit)
```


```{r larval-res-model-forest_plot}
pdf(here("output", "larval-res-model-forest-plot.pdf"))

larval_res_fit$summary.fixed %>% 
  select(quant025 = "0.025quant", median = "0.5quant", quant975 = "0.975quant") %>% 
  mutate(names = c(
    "(Intercept)",
    "Distance to river", 
    "Rice paddy",
    "Cropland",
    "Toilets",
    "Water containers",
    "Insecticide",
    "Larvicide",
    "NFI",
    "Wet season"
  )) %>% 
  filter(names != "(Intercept)") %>% 
  ggplot(aes(x = median, y = names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("")

dev.off()
```


```{r load-larval-res-model-forest-plot, eval = TRUE, fig.cap="Results with larvae containg water containers as response"}
include_graphics(here("output", "larval-res-model-forest-plot.pdf"))
```


## Adult mosquito models  
```{r adult-data-match}
aedes_adult_red_og <- aedes_red %>% 
  filter(visit == "visit1")

#### Incorporate adult Aedes mosquito data
adult_data <- read_csv(here("data", "MosqAdultData_UTM48N.csv"), show_col_types = FALSE) %>% 
  clean_names() %>% 
  select(
    adult_x = x, adult_y = y, adult_lon = e, adult_lat = n,
    date_placed, 
    total_aed, w1_aeg, w2_aed, w3_aed, w4_aed, w5_aed, w6_aed, w7_aed, w8_aed
  )
  

# ## Match nearest adult count to aedes data
# adult_nn <- nn2(
#   data = select(adult_data, adult_x, adult_y),
#   query = select(aedes_adult_red_og, x, y),
#   searchtype = "radius",
#   k = 1,
#   radius = 250
# )
# 
# matched <- adult_nn$nn.idx != 0
# 
# aedes_adult_red <- aedes_adult_red_og %>% 
#   mutate(adult_count = rep(NA, nrow(aedes_adult_red_og)))
# 
# aedes_adult_red$adult_count[matched] <- adult_data$total_aed[adult_nn$nn.idx[matched]]


## Match nearest larval count to aedes data
aedes_adult_red <- aedes_adult_red_og
aedes_adult_red$ave_adult_count <- NA



adult_coord <- as.matrix(select(adult_data, adult_x, adult_y))
    
max_nrow <- nrow(aedes_adult_red)
    
for(i in 1:max_nrow){
  id_coord <- as.matrix(aedes_adult_red[i, c("x", "y")])

  dists <- sqrt((id_coord[1] - adult_coord[, 1])^2 + (id_coord[2] - adult_coord[, 2])^2)
    
  if(sum(dists <= 250) > 0) {
      aedes_adult_red$ave_adult_count[i] <- mean(adult_data$total_aed[dists <= 250])
  } else {
    aedes_adult_red$ave_adult_count[i] <- NA
  }
}
```


```{r plot-showing-adult-subsetting}
pdf(here("output", "adult-subsetting-plot1.pdf"), width = 10)

aedes_adult_red %>% 
    ggplot(aes(x = x, y = y, color = ave_adult_count)) +
      geom_point(alpha = 0.85) +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_adult_red$x)) +
      ylim(range(aedes_adult_red$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched")
  
dev.off()


pdf(here("output", "adult-subsetting-plot2.pdf"), width = 10)

  aedes_adult_red %>% 
    filter(!is.na(ave_adult_count)) %>% 
    ggplot(aes(x = x, y = y, color = ave_adult_count))+
      geom_point(alpha = 0.85) +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_adult_red$x)) +
      ylim(range(aedes_adult_red$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched reduced")
  
dev.off()


pdf(here("output", "adult-subsetting-plot3.pdf"), width = 10)

  adult_data %>% 
    mutate(adult_count = total_aed) %>% 
    ggplot(aes(x = adult_x, y = adult_y, color = adult_count)) +
      geom_point(alpha = 0.85) +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_adult_red$x)) +
      ylim(range(aedes_adult_red$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Adult data")

dev.off()
```


```{r load-adult-subsetting-plot3, eval = TRUE}
include_graphics(here("output", "adult-subsetting-plot3.pdf"))
```

```{r load-adult-subsetting-plot1, eval = TRUE}
include_graphics(here("output", "adult-subsetting-plot1.pdf"))
```

```{r load-adult-subsetting-plot2, eval = TRUE}
include_graphics(here("output", "adult-subsetting-plot2.pdf"))
```

```{r saliva-vs-adult}
ggplot(aedes_adult_red, aes(x = adult_count, y = log_saliva_elisa)) +
  geom_point() +
  xlab("Nearby count of adult mosquitos (total from 8 weeks of collecting)") +
  theme_bw()
```

### Added adult count predictor

```{r adult-model-prep}
## extract relevant data (not sure if sorting is necessary)
coords_st <- aedes_adult_red %>% 
  filter(!is.na(ave_adult_count)) %>% 
  mutate(modal_land_type = droplevels(modal_land_type)) %>% 
  arrange(study_id) %>% 
  select(
    lon = x, lat = y, 
    log_saliva_elisa,
    gender,
    age_cented7, distance_to_river_scaled,
    modal_land_type,
    num_toilets_in_home, num_domestic_water_containers_in_home,
    insecticide_spray, larvicide_applied_to_water,
    NFI250_home,
    ave_adult_count
    )

## specify df of covariate values including intercept
covar_df <- data.frame(
  # Intercept = rep(1, nrow(coords_st)),
  select(coords_st, -c( lon, lat, log_saliva_elisa))
)
  
## extract coordinates as matrix, ignoring repeats
coords <- select(coords_st, lon, lat) %>% 
  distinct() %>% 
  as.matrix()

## create mesh, good documentation available to understand all options
mesh <- inla.mesh.2d(
  loc = coords,
  max.edge = c(300, 600)
)

# specify spde
spde <- inla.spde2.matern(mesh)

# Need to specify index with spde and group (if there are replicates)
s.index <- inla.spde.make.index(
  "spatial.field", 
  n.spde = spde$n.spde
)

## A specifies something about edge length based on the mesh
A <- inla.spde.make.A(
  mesh = mesh, 
  loc = as.matrix(select(coords_st, lon, lat))
)

## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
stack <- inla.stack(
  data = list(y = coords_st$log_saliva_elisa),
  A = list(A, 1),
  effects = list(
    s.index,
    list(covar_df = covar_df)
  ),
  tag = "est"
)

## specify model formula, 'f()' incorporates spatial effect and replicate 
formula <- y ~ #0 + Intercept
  gender + 
  age_cented7  + distance_to_river_scaled +
  modal_land_type +
  num_toilets_in_home + num_domestic_water_containers_in_home +
  insecticide_spray + larvicide_applied_to_water  +
  NFI250_home  +
  ave_adult_count +
  f(
    spatial.field, 
    model = spde
  )
  

## fixed effect priors
coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
)
```


```{r adult-model-fit}
if(params$refit_adult_fit) {
  adult_fit <- inla(
    formula, 
    data = inla.stack.data(stack),
    control.predictor = list(
      A = inla.stack.A(stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )
  
  saveRDS(adult_fit, here("output", "adult_fit.rds"))
} else {
  adult_fit <- readRDS(here("output", "adult_fit.rds"))
}
```


```{r adult-model-summary}
summary(adult_fit)
```


```{r adult-model-forest-plot}
adult_fit_df <- adult_fit$summary.fixed %>% 
  mutate(unordered_names = rownames(adult_fit$summary.fixed)) %>% 
  mutate(pred_names = factor(
    unordered_names,
    levels = c(
      pred_rownames_ordered[pred_rownames_ordered != "modal_land_typerice paddy"], 
      "ave_adult_count"
    ),
    labels = c(pred_names_vec[pred_names_vec != "Rice paddy"], "Ave Mosquito count")
  )) %>% 
  select(quant025 = "0.025quant", mean = "mean", quant975 = "0.975quant", pred_names) 


pdf(here("output", "adult-model-forest-plot.pdf"))

adult_fit_df %>% 
  filter(pred_names != "(Intercept)") %>% 
  ggplot(aes(x = mean, y = pred_names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("") +
    scale_y_discrete(limits = rev)

dev.off()
```


```{r load-adult-model-forest-plot, eval = TRUE, fig.cap="Full model results with adult mosquito count added."}
include_graphics(here("output", "adult-model-forest-plot.pdf"))
```


### Adult count as response  

```{r adult-res-model-prep}
## extract relevant data
coords_st <- aedes_adult_red %>% 
  filter(!is.na(ave_adult_count)) %>% 
  mutate(modal_land_type = droplevels(modal_land_type)) %>% 
  arrange(study_id) %>% 
  select(
    lon = x, lat = y, 
    distance_to_river_scaled,
    modal_land_type,
    num_toilets_in_home, num_domestic_water_containers_in_home,
    insecticide_spray, larvicide_applied_to_water,
    NFI250_home,
    ave_adult_count
    )

## Extact train and test data sets
set.seed(1236)

train_ind <- sample(
  1:nrow(coords_st), 
  size = floor(0.75 * nrow(coords_st))
)

ad_train <- coords_st[train_ind, ]
ad_test <- coords_st[-train_ind, ]

## specify df of covariate values including intercept
covar_df <- data.frame(
  # Intercept = rep(1, nrow(coords_st)),
  select(coords_st, -c( lon, lat, ave_adult_count))
)

train_covar <- covar_df[train_ind, ]
test_covar <- covar_df[-train_ind, ]

## extract coordinates as matrix
coords <- select(coords_st, lon, lat) %>% 
  distinct() %>% 
  as.matrix()

train_coords <- coords[train_ind, ]
test_coords <- coords[-train_ind, ]

## create mesh, shared
mesh <- inla.mesh.2d(
  loc = coords,
  max.edge = c(300, 600)
)

# specify spde, shared
spde <- inla.spde2.matern(mesh)

# Need to specify index with spde and group (if there are replicates)
s.index <- inla.spde.make.index(
  "spatial.field", 
  n.spde = spde$n.spde
)

## A specifies something about edge length based on the mesh
train_A <- inla.spde.make.A(
  mesh = mesh, 
  loc = train_coords
)

test_A <- inla.spde.make.A(
  mesh = mesh, 
  loc = test_coords
)

## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
train_stack <- inla.stack(
  data = list(y = ad_train$ave_adult_count),
  A = list(train_A, 1),
  effects = list(
    s.index,
    list(train_covar = train_covar)
  ),
  tag = "est"
)

test_stack <- inla.stack(
  data = list(y = rep(NA, nrow(ad_test))),
  A = list(test_A, 1),
  effects = list(
    s.index,
    list(train_covar = test_covar)
  ),
  tag = "pred"
)

full_stk <- inla.stack(train_stack, test_stack)

## specify model formula, 'f()' incorporates spatial effect and replicate 
formula <- y ~ #0 + Intercept
  distance_to_river_scaled +
  modal_land_type +
  num_toilets_in_home + num_domestic_water_containers_in_home +
  insecticide_spray + larvicide_applied_to_water  +
  NFI250_home  +
  f(
    spatial.field, 
    model = spde
  )
  

## fixed effect priors
coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
)
```


```{r adult-res-model-fit}
if(params$refit_adult_fit) {
  adult_res_fit <- inla(
    formula, 
    data = inla.stack.data(full_stk),
    family = "gaussian",
    control.predictor = list(
      A = inla.stack.A(full_stk),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )
  
  saveRDS(adult_res_fit, here("output", "adult_res_fit.rds"))
} else {
  adult_res_fit <- readRDS(here("output", "adult_res_fit.rds"))
}
```


```{r}
ggplot_inla_residuals2(
  adult_res_fit, 
  coords_st$ave_adult_count, 
  se = FALSE
) +
  theme_bw()
```


```{r adult-res-model-summary}
summary(adult_res_fit)
```

```{r}
index_pred <- inla.stack.index(full_stk, "pred")$data
pred <- adult_res_fit$summary.linear.predictor[index_pred, "mean"]

obs <- ad_test$ave_adult_count

plot(x = obs, y = pred)

summary(lm(obs ~ pred))
```



```{r adult-res-model-forest-plot}
pdf(here("output", "adult-res-model-forest-plot.pdf"))

adult_res_fit$summary.fixed %>% 
  select(quant025 = "0.025quant", median = "0.5quant", quant975 = "0.975quant") %>% 
  mutate(names = c(
    "(Intercept)",
    "Distance to river", 
    "Cropland",
    "Toilets",
    "Water containers",
    "Insecticide",
    "Larvicide",
    "NFI"
  )) %>% 
  filter(names != "(Intercept)") %>% 
  ggplot(aes(x = median, y = names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("")

dev.off()
```


```{r load-adult-res-model-forest-plot, eval = TRUE, fig.cap="Adult mosquito count as response."}
include_graphics(here("output", "adult-res-model-forest-plot.pdf"))
```