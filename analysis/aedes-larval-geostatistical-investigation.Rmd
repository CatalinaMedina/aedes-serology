---
title: "aedes-larval-geostatistical-investigation"
output: pdf_document
header-includes:
  - \usepackage{float}
params:   
  refit_larval_fit: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, eval = FALSE, 
  fig.pos = 'H', fig.align = "center",
  message = FALSE, warning = FALSE
)
```


```{r libraries, eval = TRUE}
library(here)
library(readxl)
library(janitor)
library(zoo)
library(RANN)
library(viridis)
library(gridExtra)
library(knitr)
library(sf)
library(ggsn)
library(ggmap)
library(lattice)
library(magrittr)
library(knitr)
library(kableExtra)
library(INLAutils)
library(tidyverse)

library(INLA)

source(here("analysis", "process-modis-data-function.R"))
```


### Set up larval data 
- The house hold survey data contains the `container index` which is the # of water containers that contained larvae in a house. This survey has different sampling units, and only has measurements around the times of visits 1 through 4.
- The Aedes serology individual's houses were matched to nearest `container index`, within a 300 meter radius. This subsetting is visualized in plots below.
- The same predictors from the full model were used in addition to this new larval predictor named `larval %`, and without the visit 5 predictor, to model log exposure as before


```{r load full aedes data}
aedes_red <- readRDS(file = here("data", "processed_aedes_data.rds")) 

aedes_red_ind <- aedes_red %>%
  filter(visit == "visit1") %>% 
  mutate(visit = droplevels(visit))
```


```{r larval-data-match}
aedes_larval_red_og <- aedes_red %>% 
  filter(visit != "visit5") %>% 
  mutate(visit = droplevels(visit))

#### Incorporate larval data
larval_lat_lo <- read_csv(here("data", "HH_Surveys_19Jan_UTM48N.csv"), show_col_types = FALSE) %>% 
  select(
    larval_X = "X...1",
    larval_Y = "Y...2",
    larval_lon = "X...3",
    larval_lat = "Y...4",
    house_num = "name",
    subj_id = "SUBJID"
  ) %>% 
  mutate(subj_id = as.character(as.numeric(subj_id))) %>% 
  filter(!duplicated(subj_id)) #subjects 389 and 716 had repeat measurements; 1st kept
    
  
larval_hs <- read_xlsx(here("data", "House Survey Data_Extracted 03May2021.xlsx")) %>%
  select(
    subj_id = SUBJID,
    water_containers_og = WATERCON,
    water_larvae = WATERLARVAE,
    visit_year = Year,
    visit_month = Month
  ) %>% 
  mutate(subj_id = as.character(subj_id)) %>% 
  filter(!is.na(visit_year)) %>% 
  mutate(visit_date = ym(paste(visit_year, visit_month))) %>% 
  mutate(visit = factor(case_when(
    visit_year == 2018 & visit_month >= 5 & visit_month <= 9 ~ "visit1",
    visit_year == 2019 & !(visit_month >= 5 & visit_month <= 9) ~ "visit2",
    visit_year == 2019 & visit_month >= 5 & visit_month <= 9 ~ "visit3",
    visit_year == 2020 & !(visit_month >= 5 & visit_month <= 9) ~ "visit4"
  ))) %>% 
  mutate(water_containers = ifelse(
    water_containers_og == "*", 
    99999,
    as.numeric(water_containers_og))) %>% 
  filter(water_containers != 9999) %>% 
  mutate(container_index = ifelse(
    water_containers != 0,
      as.numeric(water_larvae) / as.numeric(water_containers),
    0
  )) %>% 
  mutate(con_w_larvae = as.numeric(water_larvae)) %>% 
  left_join(y = larval_lat_lo) 

  
## Match nearest larval count to aedes data
aedes_larval_red <- aedes_larval_red_og
aedes_larval_red$ave_larv_cont <- NA
aedes_l_red <- NA


for(v in levels(aedes_larval_red$visit)) {
  larval_hs_red <- filter(larval_hs, visit == v)
  larval_coord <- as.matrix(select(larval_hs_red, larval_X, larval_Y))
    
  aedes_larval_red <- filter(aedes_larval_red_og, visit == v)
  
  curr_nrow <- nrow(aedes_larval_red)
    
  for(i in 1:curr_nrow){
    id_coord <- as.matrix(aedes_larval_red[i, c("x", "y")])

    dists <- sqrt((id_coord[1] - larval_coord[, 1])^2 + (id_coord[2] - larval_coord[, 2])^2)
    
    if(sum(dists <= 250) > 0) {
      aedes_larval_red$ave_larv_cont[i] <- mean(larval_hs_red$con_w_larvae[dists <= 250])
    } else {
      aedes_larval_red$ave_larv_cont[i] <- NA
    }
  }
  
  if(v == "visit1") {
    aedes_l_red <- aedes_larval_red
  } else {
    aedes_l_red <- bind_rows(aedes_l_red, aedes_larval_red)
  }
}

aedes_red_w_larval <- aedes_l_red %>% 
  arrange(study_id, visit)
```


```{r plot-showing-larval-subsetting}
pdf(here("output", "larval-subsetting-plot1.pdf"), width = 10)

aedes_red_w_larval %>% 
    mutate(Larvae = ave_larv_cont) %>% 
    ggplot(aes(x = x, y = y, color = Larvae)) +
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_red_w_larval$x)) +
      ylim(range(aedes_red_w_larval$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched")
  
dev.off()


pdf(here("output", "larval-subsetting-plot2.pdf"), width = 10)

  aedes_red_w_larval %>% 
    filter(!is.na(ave_larv_cont)) %>% 
    mutate(Larvae = ave_larv_cont) %>% 
    ggplot(aes(x = x, y = y, color = Larvae))+
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_red_w_larval$x)) +
      ylim(range(aedes_red_w_larval$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched reduced")
  
dev.off()


pdf(here("output", "larval-subsetting-plot3.pdf"), width = 10)

  larval_hs %>% 
    mutate(Larvae = con_w_larvae) %>% 
    ggplot(aes(x = larval_X, y = larval_Y, color = Larvae)) +
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_red_w_larval$x)) +
      ylim(range(aedes_red_w_larval$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Larval data")
  


dev.off()
```


```{r load-larval-subsetting-plot3, eval = TRUE}
include_graphics(here("output", "larval-subsetting-plot3.pdf"))
```

```{r load-larval-subsetting-plot1, eval = TRUE}
include_graphics(here("output", "larval-subsetting-plot1.pdf"))
```

```{r load-larval-subsetting-plot2, eval = TRUE}
include_graphics(here("output", "larval-subsetting-plot2.pdf"))
```


```{r saliva-vs-larvae}
ggplot(aedes_red_w_larval, aes(x = ave_larv_cont, y = log_saliva_elisa)) +
  geom_point() +
  xlab("Average number of water containers with larae found in 250m radius") +
  theme_bw()
```


### Added containters with larvae as predictor
```{r larval-model-prep}
## extract relevant data (not sure if sorting is necessary)
coords_st <- aedes_red_w_larval %>% 
  filter(!is.na(ave_larv_cont)) %>% 
  arrange(study_id, time) %>% 
  select(
    time, 
    lon = x, lat = y, 
    log_saliva_elisa,
    gender,
    age_cented7, distance_to_river_scaled,
    modal_land_type,
    num_toilets_in_home, num_domestic_water_containers_in_home,
    insecticide_spray, larvicide_applied_to_water,
    NFI250_home,
    wet_season,
    ave_larv_cont
    )

## specify df of covariate values including intercept
covar_df <- data.frame(
  # Intercept = rep(1, nrow(coords_st)),
  select(coords_st, -c(time, lon, lat, log_saliva_elisa))
)
  
## extract coordinates as matrix, ignoring repeats
coords <- select(coords_st, lon, lat) %>% 
  distinct() %>% 
  as.matrix()

## create mesh, good documentation available to understand all options
mesh <- inla.mesh.2d(
  loc = coords,
  max.edge = c(300, 600)
)

# specify spde
spde <- inla.spde2.matern(mesh)

# Need to specify index with spde and group (if there are replicates)
s.index <- inla.spde.make.index(
  "spatial.field", 
  n.spde = spde$n.spde,
  n.group = 4
)

## A specifies something about edge length based on the mesh
A <- inla.spde.make.A(
  mesh = mesh, 
  loc = as.matrix(select(coords_st, lon, lat)), 
  group = coords_st$time
)

## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
stack <- inla.stack(
  data = list(y = coords_st$log_saliva_elisa),
  A = list(A, 1),
  effects = list(
    s.index,
    list(covar_df = covar_df)
  ),
  tag = "est"
)

## specify model formula, 'f()' incorporates spatial effect and replicate 
formula <- y ~ #0 + Intercept
  gender + 
  age_cented7  + distance_to_river_scaled +
  modal_land_type +
  num_toilets_in_home + num_domestic_water_containers_in_home +
  insecticide_spray + larvicide_applied_to_water  +
  NFI250_home  +
  wet_season +
  ave_larv_cont +
  f(
    spatial.field, 
    model = spde, 
    group = spatial.field.group, 
    control.group = list(model = "iid")
  )
  

## fixed effect priors
coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
)
```


```{r larval-model-fit}
if(params$refit_larval_fit) {
  larval_fit <- inla(
    formula, 
    data = inla.stack.data(stack),
    control.predictor = list(
      A = inla.stack.A(stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )

  # Warning in inla(formula, data = inla.stack.data(stack), control.predictor = list(A = inla.stack.A(stack)),  :
  # The A-matrix in the predictor (see ?control.predictor) is specified
  # but an intercept is in the formula. This will likely result
  # in the intercept being applied multiple times in the model, and is likely
  # not what you want. See ?inla.stack for more information.
  # You can remove the intercept adding ``-1'' to the formula.
  
  saveRDS(larval_fit, here("output", "larval_fit.rds"))
} else {
  larval_fit <- readRDS(here("output", "larval_fit.rds"))
}
```


```{r larval-model-summary}
summary(larval_fit)
```


```{r larval-model-forest_plot}
larval_fit_df <- larval_fit$summary.fixed %>% 
  mutate(unordered_names = rownames(larval_fit$summary.fixed)) %>% 
  mutate(pred_names = factor(
    unordered_names,
    levels = c(pred_rownames_ordered, "ave_larv_cont"),
    labels = c(pred_names_vec, "Larval containers")
  )) %>% 
  select(quant025 = "0.025quant", mean = "mean", quant975 = "0.975quant", pred_names) 

    
pdf(here("output", "larval-model-forest-plot.pdf"))

larval_fit_df %>% 
  filter(pred_names != "(Intercept)") %>% 
  ggplot(aes(x = mean, y = pred_names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("") +
  scale_y_discrete(limits = rev)

dev.off()
```


```{r load-larval-model-forest-plot, eval = TRUE, fig.cap="Full model results with larvae containg water containers added."}
include_graphics(here("output", "larval-model-forest-plot.pdf"))
```


### Containters with larvae as response
```{r larval-res-model-prep}
## extract relevant data (not sure if sorting is necessary)
coords_st <- aedes_red_w_larval %>% 
  filter(!is.na(ave_larv_cont)) %>% 
  arrange(study_id, time) %>% 
  select(
    time, 
    lon = x, lat = y, 
    distance_to_river_scaled,
    modal_land_type,
    num_toilets_in_home, num_domestic_water_containers_in_home,
    insecticide_spray, larvicide_applied_to_water,
    NFI250_home,
    wet_season,
    ave_larv_cont
    )

## specify df of covariate values including intercept
covar_df <- data.frame(
  # Intercept = rep(1, nrow(coords_st)),
  select(coords_st, -c(time, lon, lat, ave_larv_cont))
)
  
## extract coordinates as matrix, ignoring repeats
coords <- select(coords_st, lon, lat) %>% 
  distinct() %>% 
  as.matrix()

## create mesh, good documentation available to understand all options
mesh <- inla.mesh.2d(
  loc = coords,
  max.edge = c(300, 600)
)

# specify spde
spde <- inla.spde2.matern(mesh)

# Need to specify index with spde and group (if there are replicates)
s.index <- inla.spde.make.index(
  "spatial.field", 
  n.spde = spde$n.spde,
  n.group = 4
)

## A specifies something about edge length based on the mesh
A <- inla.spde.make.A(
  mesh = mesh, 
  loc = as.matrix(select(coords_st, lon, lat)), 
  group = coords_st$time
)

## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
stack <- inla.stack(
  data = list(y = coords_st$ave_larv_cont),
  A = list(A, 1),
  effects = list(
    s.index,
    list(covar_df = covar_df)
  ),
  tag = "est"
)

## specify model formula, 'f()' incorporates spatial effect and replicate 
formula <- y ~ #0 + Intercept
  distance_to_river_scaled +
  modal_land_type +
  num_toilets_in_home + num_domestic_water_containers_in_home +
  insecticide_spray + larvicide_applied_to_water  +
  NFI250_home  +
  wet_season +
  f(
    spatial.field, 
    model = spde, 
    group = spatial.field.group, 
    control.group = list(model = "iid")
  )
  

## fixed effect priors
coeff_priors <- list(
    mean.intercept = 0,
    prec.intercept = 1/(2.5^2),
    mean = list(default = 0),
    prec = list(default = 1/(2.5^2))
)
```


```{r larval-res-model-fit}
if(params$refit_larval_fit) {
  larval_res_fit <- inla(
    formula, 
    data = inla.stack.data(stack),
    control.predictor = list(
      A = inla.stack.A(stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )

  # Warning in inla(formula, data = inla.stack.data(stack), control.predictor = list(A = inla.stack.A(stack)),  :
  # The A-matrix in the predictor (see ?control.predictor) is specified
  # but an intercept is in the formula. This will likely result
  # in the intercept being applied multiple times in the model, and is likely
  # not what you want. See ?inla.stack for more information.
  # You can remove the intercept adding ``-1'' to the formula.
  
  saveRDS(larval_res_fit, here("output", "larval_res_fit.rds"))
} else {
  larval_res_fit <- readRDS(here("output", "larval_res_fit.rds"))
}
```


```{r}
ggplot_inla_residuals2(
  larval_res_fit, 
  coords_st$ave_larv_cont, 
  se = FALSE
) +
  theme_bw()
```


```{r larval-res-model-summary}
summary(larval_res_fit)

## Check that pred_rownames and pred_name_vec line up
pred_rownames_ordered <- c(
  "(Intercept)",
  "genderMale",
  "age_cented7",
  "modal_land_typerice paddy",
  "modal_land_typecropland",
  "distance_to_river_scaled",
  "insecticide_sprayYes",
  "larvicide_applied_to_waterYes",
  "num_toilets_in_home",
  "num_domestic_water_containers_in_home",
  "NFI250_home",
  "wet_seasonyes"
)

pred_names_vec = c(
  "(Intercept)",
  "Male", 
  "Age", 
  "Rice paddy",
  "Cropland",
  "Distance to river", 
  "Insecticide",
  "Larvicide",
  "Toilets",
  "Water containers",
  "NFI",
  "Wet season"
)
```


```{r larval-res-model-forest_plot}
pdf(here("output", "larval-res-model-forest-plot.pdf"))

larval_res_fit$summary.fixed %>% 
  select(quant025 = "0.025quant", median = "0.5quant", quant975 = "0.975quant") %>% 
  mutate(names = c(
    "(Intercept)",
    "Distance to river", 
    "Rice paddy",
    "Cropland",
    "Toilets",
    "Water containers",
    "Insecticide",
    "Larvicide",
    "NFI",
    "Wet season"
  )) %>% 
  filter(names != "(Intercept)") %>% 
  ggplot(aes(x = median, y = names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("")

dev.off()
```


```{r load-larval-res-model-forest-plot, eval = TRUE, fig.cap="Results with larvae containg water containers as response"}
include_graphics(here("output", "larval-res-model-forest-plot.pdf"))
```


