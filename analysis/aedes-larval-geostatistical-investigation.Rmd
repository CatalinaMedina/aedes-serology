---
title: "aedes-larval-geostatistical-investigation"
output: pdf_document
header-includes:
  - \usepackage{float}
params:   
  refit_full_model_wo_larval: FALSE
  refit_full_model_w_larval: FALSE
  refit_model_w_larval_wo_enviro: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, eval = TRUE, 
  fig.pos = 'H', fig.align = "center",
  message = FALSE, warning = FALSE
)
```


```{r libraries, eval = TRUE}
library(here)
library(readxl)
library(janitor)
library(zoo)
library(RANN)
library(viridis)
library(gridExtra)
library(knitr)
library(sf)
library(ggsn)
library(lattice)
library(magrittr)
library(knitr)
library(kableExtra)
library(INLAutils)
library(tidyverse)

library(INLA)

source(here("analysis", "process-modis-data-function.R"))
```


### Set up larval data 
- The house hold survey data contains the `container index` which is the # of water containers that contained larvae in a house. This survey has different sampling units, and only has measurements around the times of visits 1 through 4.
- The Aedes serology individual's houses were matched to nearest `container index`, within a 300 meter radius. This subsetting is visualized in plots below.
- The same predictors from the full model were used in addition to this new larval predictor named `larval %`, and without the visit 5 predictor, to model log exposure as before


```{r load full aedes data}
aedes_red <- readRDS(file = here("data", "processed_aedes_data.rds")) 

aedes_red_ind <- aedes_red %>%
  filter(visit == "visit1") %>% 
  mutate(visit = droplevels(visit))

## Check that pred_rownames and pred_name_vec line up
pred_rownames_ordered <- c(
  "(Intercept)",
  "genderMale",
  "age_cented7",
  "insecticide_sprayYes",
  "larvicide_applied_to_waterYes",
  "num_toilets_in_home",
  "num_domestic_water_containers_in_home",
  "modal_land_typerice paddy",
  "modal_land_typecropland",
  "distance_to_river_scaled",
  "wet_seasonyes",
  "NFI250_home"
)
pred_names_vec = c(
  "(Intercept)",
  "Male", 
  "Age", 
  "Insecticide used",
  "Larvicide used",
  "Number of toilets",
  "Number of water containers",
  "Rice paddy",
  "Cropland",
  "Distance to river (std.)", 
  "Wet season",
  "Flooding index (NFI)"
)
```


```{r larval-data-match}
aedes_larval_red_og <- aedes_red %>% 
  filter(visit != "visit5") %>% 
  mutate(visit = droplevels(visit))

#### Incorporate larval data
larval_lat_lo <- read_csv(here("data", "HH_Surveys_19Jan_UTM48N.csv"), show_col_types = FALSE) %>% 
  select(
    larval_X = "X...1",
    larval_Y = "Y...2",
    larval_lon = "X...3",
    larval_lat = "Y...4",
    house_num = "name",
    subj_id = "SUBJID"
  ) %>% 
  mutate(subj_id = as.character(as.numeric(subj_id))) %>% 
  filter(!duplicated(subj_id)) #subjects 389 and 716 had repeat measurements; 1st kept
    
  
larval_hs <- read_xlsx(here("data", "House Survey Data_Extracted 03May2021.xlsx")) %>%
  select(
    subj_id = SUBJID,
    water_containers_og = WATERCON,
    water_larvae = WATERLARVAE,
    visit_year = Year,
    visit_month = Month
  ) %>% 
  mutate(subj_id = as.character(subj_id)) %>% 
  filter(!is.na(visit_year)) %>% 
  mutate(visit_date = ym(paste(visit_year, visit_month))) %>% 
  mutate(visit = factor(case_when(
    visit_year == 2018 & visit_month >= 5 & visit_month <= 9 ~ "visit1",
    visit_year == 2019 & !(visit_month >= 5 & visit_month <= 9) ~ "visit2",
    visit_year == 2019 & visit_month >= 5 & visit_month <= 9 ~ "visit3",
    visit_year == 2020 & !(visit_month >= 5 & visit_month <= 9) ~ "visit4"
  ))) %>% 
  mutate(water_containers = ifelse(
    water_containers_og == "*", 
    99999,
    as.numeric(water_containers_og))) %>% 
  filter(water_containers != 9999) %>% 
  mutate(container_index = ifelse(
    water_containers != 0,
      as.numeric(water_larvae) / as.numeric(water_containers),
    0
  )) %>% 
  mutate(con_w_larvae = as.numeric(water_larvae)) %>% 
  left_join(y = larval_lat_lo) 

  
## Match nearest larval count to aedes data
aedes_red_w_larval <- aedes_larval_red_og
aedes_red_w_larval$ave_larv_cont <- NA
aedes_l_red <- NA


for(v in levels(aedes_red_w_larval$visit)) {
  larval_hs_red <- filter(larval_hs, visit == v)
  larval_coord <- as.matrix(select(larval_hs_red, larval_X, larval_Y))
    
  aedes_red_w_larval <- filter(aedes_larval_red_og, visit == v)
  
  curr_nrow <- nrow(aedes_red_w_larval)
    
  for(i in 1:curr_nrow){
    id_coord <- as.matrix(aedes_red_w_larval[i, c("x", "y")])

    dists <- sqrt((id_coord[1] - larval_coord[, 1])^2 + (id_coord[2] - larval_coord[, 2])^2)
    
    if(sum(dists <= 250) > 0) {
      aedes_red_w_larval$ave_larv_cont[i] <- mean(larval_hs_red$con_w_larvae[dists <= 250])
    } else {
      aedes_red_w_larval$ave_larv_cont[i] <- NA
    }
  }
  
  if(v == "visit1") {
    aedes_l_red <- aedes_red_w_larval
  } else {
    aedes_l_red <- bind_rows(aedes_l_red, aedes_red_w_larval)
  }
}

aedes_larval_red <- aedes_l_red %>% 
  arrange(study_id, visit)


larval_pred_est <- read_csv(here("output", "larval_pred_est.csv"))
```


```{r plot-showing-larval-subsetting, eval = FALSE}
pdf(here("output", "larval-subsetting-plot1.pdf"), width = 10)

aedes_larval_red %>% 
    mutate(Larvae = ave_larv_cont) %>% 
    ggplot(aes(x = x, y = y, color = Larvae)) +
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_larval_red$x)) +
      ylim(range(aedes_larval_red$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched")
  
dev.off()


pdf(here("output", "larval-subsetting-plot2.pdf"), width = 10)

  aedes_larval_red %>% 
    filter(!is.na(ave_larv_cont)) %>% 
    mutate(Larvae = ave_larv_cont) %>% 
    ggplot(aes(x = x, y = y, color = Larvae))+
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_larval_red$x)) +
      ylim(range(aedes_larval_red$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Aedes nn matched reduced")
  
dev.off()


pdf(here("output", "larval-subsetting-plot3.pdf"), width = 10)

  larval_hs %>% 
    mutate(Larvae = con_w_larvae) %>% 
    ggplot(aes(x = larval_X, y = larval_Y, color = Larvae)) +
      geom_point() +
      scale_color_viridis(direction = -1) +
      xlim(range(aedes_larval_red$x)) +
      ylim(range(aedes_larval_red$y)) +
      xlab("") +
      ylab("") +
      coord_equal() +
      theme_bw() +
      facet_wrap(~ visit) +
      theme(
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()
      ) +
      ggtitle("Larval data")
  


dev.off()
```


```{r load-larval-subsetting-plot3, eval = FALSE}
include_graphics(here("output", "larval-subsetting-plot3.pdf"))
```

```{r load-larval-subsetting-plot1, eval = FALSE}
include_graphics(here("output", "larval-subsetting-plot1.pdf"))
```

```{r load-larval-subsetting-plot2, eval = FALSE}
include_graphics(here("output", "larval-subsetting-plot2.pdf"))
```


```{r saliva-vs-larvae, eval = FALSE}
ggplot(aedes_larval_red, aes(x = ave_larv_cont, y = log_saliva_elisa)) +
  geom_point() +
  xlab("Average number of water containers with larae found in 250m radius") +
  theme_bw()
```


### Full model with and without larval and environmental predictors
```{r full model without larval pred}
if(!params$refit_full_model_wo_larval) {
  ## Load predictions df
  fit_full_wo_larval_preds <- read_csv(file = here("output", "fit_full_wo_larval_preds.csv"))
  
} else {
  set.seed(1234)
  
  ## Repeat multiple times for cross validation
  num_coss_validation_reps <- 10
  
  fit_full_wo_larval_preds <- NULL
  
  for(j in 1:num_coss_validation_reps){
    ### Model prep
    ## extract relevant data (not sure if sorting is necessary)
    all_data <- aedes_larval_red %>% 
      filter(!is.na(ave_larv_cont)) %>% 
      arrange(study_id, time) %>% 
      select(
        time, 
        lon = x, lat = y, 
        log_saliva_elisa,
        gender,
        age_cented7, distance_to_river_scaled,
        modal_land_type,
        num_toilets_in_home, num_domestic_water_containers_in_home,
        insecticide_spray, larvicide_applied_to_water,
        NFI250_home,
        wet_season
        )
    
    ## Extract train and test data sets
    train_ind <- sample(
      1:nrow(all_data),
      size = floor(0.95 * nrow(all_data))
    )
    
    train_data <- all_data[train_ind, ]
    test_data <- all_data[-train_ind, ]
    
    ## specify df of covariate values
    all_covar_df <- data.frame(
      select(all_data, -c(time, lon, lat, log_saliva_elisa))
    )
    
    train_covar_df <- all_covar_df[train_ind, ]
    test_covar_df <- all_covar_df[-train_ind, ]
      
    ## extract coordinates as matrix, ignoring repeats
    all_coords <- all_data %>% 
      filter(time == 1) %>% 
      select(lon, lat) %>% 
      as.matrix()
    
    ## create mesh, good documentation available to understand all options
    mesh <- inla.mesh.2d(
      loc = all_coords,
      max.edge = c(300, 600)
    )
    
    # specify spde
    spde <- inla.spde2.matern(mesh)
    
    # Need to specify index with spde and group (if there are replicates)
    s.index <- inla.spde.make.index(
      "spatial.field", 
      n.spde = spde$n.spde,
      n.group = 4
    )
    
    ## A specifies something about edge length based on the mesh
    train_A <- inla.spde.make.A(
      mesh = mesh, 
      loc = as.matrix(select(train_data, lon, lat)),
      group = train_data$time
    )
    
    test_A <- inla.spde.make.A(
      mesh = mesh, 
      loc = as.matrix(select(test_data, lon, lat)),
      group = test_data$time
    )
    
    ## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
    train_stack <- inla.stack(
      data = list(y = train_data$log_saliva_elisa),
      A = list(train_A, 1),
      effects = list(
        s.index,
        list(train_covar_df = train_covar_df)
      ),
      tag = "train"
    )
    
    test_stack <- inla.stack(
      data = list(y = rep(NA, nrow(test_data))),
      A = list(test_A, 1),
      effects = list(
        s.index,
        list(test_covar_df = test_covar_df)
      ),
      tag = "test"
    )
    
    full_stack <- inla.stack(train_stack, test_stack)
    
    ## specify model formula, 'f()' incorporates spatial effect and replicate 
    formula <- y ~ #0 + Intercept
      gender + 
      age_cented7  + distance_to_river_scaled +
      modal_land_type +
      num_toilets_in_home + num_domestic_water_containers_in_home +
      insecticide_spray + larvicide_applied_to_water  +
      NFI250_home  +
      wet_season +
      f(
        spatial.field, 
        model = spde, 
        group = spatial.field.group, 
        control.group = list(model = "iid")
      )
      
    
    ## fixed effect priors
    coeff_priors <- list(
        mean.intercept = 0,
        prec.intercept = 1/(2.5^2),
        mean = list(default = 0),
        prec = list(default = 1/(2.5^2))
    )
  
    ## Fit model
    fit_full_wo_larval <- inla(
      formula, 
      data = inla.stack.data(full_stack),
      control.predictor = list(
        A = inla.stack.A(full_stack),
        compute = TRUE
      ),
      control.fixed = coeff_priors
    )
    
    
    index_pred <- inla.stack.index(full_stack, "test")$data
  
    preds_df <- data.frame(
      "pred" = fit_full_wo_larval$summary.linear.predictor[index_pred, "mean"],
      "obs" = test_data$log_saliva_elisa,
      "pred_iter" = rep(j, nrow(test_data))
    )
    
    
    fit_full_wo_larval_preds <- bind_rows(fit_full_wo_larval_preds, preds_df)
  }
  
  ## Saves predictions
  write.csv(fit_full_wo_larval_preds, file = here("output", "fit_full_wo_larval_preds.csv"), row.names = FALSE)
}
```


```{r full model with larval pred}
if(!params$refit_full_model_w_larval) {
  ## Load predictions df
  fit_full_w_larval_preds <- read_csv(file = here("output", "fit_full_w_larval_preds.csv"))
  
  ## Load overall fit without predictions
  fit_full_w_larval_no_pred <- read_csv(here("output", "fit_full_w_larval_no_pred.csv"))
  
} else {
  set.seed(1234)
  
  ## Repeat multiple times for cross validation
  num_coss_validation_reps <- 10
  
  fit_full_w_larval_preds <- NULL
  
  for(j in 1:num_coss_validation_reps){
    ### Model prep
    ## extract relevant data (not sure if sorting is necessary)
    all_data <- aedes_larval_red %>% 
      filter(!is.na(ave_larv_cont)) %>% 
      arrange(study_id, time) %>% 
      select(
        time, 
        lon = x, lat = y, 
        log_saliva_elisa,
        gender,
        age_cented7, distance_to_river_scaled,
        modal_land_type,
        num_toilets_in_home, num_domestic_water_containers_in_home,
        insecticide_spray, larvicide_applied_to_water,
        NFI250_home,
        wet_season,
        ave_larv_cont
        )
    
    ## Extract train and test data sets
    train_ind <- sample(
      1:nrow(all_data),
      size = floor(0.95 * nrow(all_data))
    )
    
    train_data <- all_data[train_ind, ]
    test_data <- all_data[-train_ind, ]
    
    ## specify df of covariate values
    all_covar_df <- data.frame(
      select(all_data, -c(time, lon, lat, log_saliva_elisa))
    )
    
    train_covar_df <- all_covar_df[train_ind, ]
    test_covar_df <- all_covar_df[-train_ind, ]
      
    ## extract coordinates as matrix, ignoring repeats
    all_coords <- all_data %>% 
      filter(time == 1) %>% 
      select(lon, lat) %>% 
      as.matrix()
    
    ## create mesh, good documentation available to understand all options
    mesh <- inla.mesh.2d(
      loc = all_coords,
      max.edge = c(300, 600)
    )
    
    # specify spde
    spde <- inla.spde2.matern(mesh)
    
    # Need to specify index with spde and group (if there are replicates)
    s.index <- inla.spde.make.index(
      "spatial.field", 
      n.spde = spde$n.spde,
      n.group = 4
    )
    
    ## A specifies something about edge length based on the mesh
    train_A <- inla.spde.make.A(
      mesh = mesh, 
      loc = as.matrix(select(train_data, lon, lat)),
      group = train_data$time
    )
    
    test_A <- inla.spde.make.A(
      mesh = mesh, 
      loc = as.matrix(select(test_data, lon, lat)),
      group = test_data$time
    )
    
    ## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
    train_stack <- inla.stack(
      data = list(y = train_data$log_saliva_elisa),
      A = list(train_A, 1),
      effects = list(
        s.index,
        list(train_covar_df = train_covar_df)
      ),
      tag = "train"
    )
    
    test_stack <- inla.stack(
      data = list(y = rep(NA, nrow(test_data))),
      A = list(test_A, 1),
      effects = list(
        s.index,
        list(test_covar_df = test_covar_df)
      ),
      tag = "test"
    )
    
    full_stack <- inla.stack(train_stack, test_stack)
    
    ## specify model formula, 'f()' incorporates spatial effect and replicate 
    formula <- y ~ #0 + Intercept
      gender + 
      age_cented7  + distance_to_river_scaled +
      modal_land_type +
      num_toilets_in_home + num_domestic_water_containers_in_home +
      insecticide_spray + larvicide_applied_to_water  +
      NFI250_home  +
      wet_season +
      ave_larv_cont +
      f(
        spatial.field, 
        model = spde, 
        group = spatial.field.group, 
        control.group = list(model = "iid")
      )
      
    
    ## fixed effect priors
    coeff_priors <- list(
        mean.intercept = 0,
        prec.intercept = 1/(2.5^2),
        mean = list(default = 0),
        prec = list(default = 1/(2.5^2))
    )
  
    ## Fit model
    fit_full_w_larval <- inla(
      formula, 
      data = inla.stack.data(full_stack),
      control.predictor = list(
        A = inla.stack.A(full_stack),
        compute = TRUE
      ),
      control.fixed = coeff_priors
    )
    
    
    index_pred <- inla.stack.index(full_stack, "test")$data
  
    preds_df <- data.frame(
      "pred" = fit_full_w_larval$summary.linear.predictor[index_pred, "mean"],
      "obs" = test_data$log_saliva_elisa,
      "pred_iter" = rep(j, nrow(test_data))
    )
    
    
    fit_full_w_larval_preds <- bind_rows(fit_full_w_larval_preds, preds_df)
  }
  

  ## Saves predictions
  write.csv(fit_full_w_larval_preds, file = here("output", "fit_full_w_larval_preds.csv"), row.names = FALSE)
  
  
  ### Fit model on all data to get coefficient estimate
  ## A specifies something about edge length based on the mesh
  all_A <- inla.spde.make.A(
    mesh = mesh, 
    loc = as.matrix(select(all_data, lon, lat)),
    group = all_data$time
  )

  ## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
  data_stack <- inla.stack(
    data = list(y = all_data$log_saliva_elisa),
    A = list(all_A, 1),
    effects = list(
      s.index,
      list(all_covar_df = all_covar_df)
    ),
    tag = "est"
  )
  
  ## Fit model
  fit_full_w_larval_no_pred <- inla(
    formula, 
    data = inla.stack.data(data_stack),
    control.predictor = list(
      A = inla.stack.A(data_stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )
    
  larval_pred_est[2, ] <- fit_full_w_larval_no_pred$summary.fixed["ave_larv_cont", c("mean", "0.025quant", "0.975quant")]
  
  
  fit_full_w_larval_no_pred_temp <- fit_full_w_larval_no_pred_all$summary.fixed %>% 
    mutate(unordered_names = rownames(fit_full_w_larval_no_pred_all$summary.fixed)) %>% 
    mutate(pred_names = factor(
      unordered_names,
      levels = c(pred_rownames_ordered, "ave_larv_cont"),
      labels = c(pred_names_vec, "Ave. larvae contaminated containers")
    )) %>% 
    arrange(pred_names) %>% 
    select(quant025 = "0.025quant", mean = "mean", quant975 = "0.975quant", pred_names) 

  write_csv(
    fit_full_w_larval_no_pred_temp,
    here("output", "fit_full_w_larval_no_pred.csv")
  )
}
```


```{r full model without enviro preds}
if(!params$refit_model_w_larval_wo_enviro) {
  ## Load predictions df
  fit_full_wo_enviro_preds <- read_csv(file = here("output", "fit_full_wo_enviro_preds.csv"))
  
} else {
  set.seed(1234)
  
  ## Repeat multiple times for cross validation
  num_coss_validation_reps <- 10
  
  fit_full_wo_enviro_preds <- NULL
  
  for(j in 1:num_coss_validation_reps){
    ### Model prep
    ## extract relevant data (not sure if sorting is necessary)
    all_data <- aedes_larval_red %>% 
      filter(!is.na(ave_larv_cont)) %>% 
      arrange(study_id, time) %>% 
      select(
        time, 
        lon = x, lat = y, 
        log_saliva_elisa,
        gender,
        age_cented7, #distance_to_river_scaled,
        #modal_land_type,
        num_toilets_in_home, num_domestic_water_containers_in_home,
        insecticide_spray, larvicide_applied_to_water,
        #NFI250_home,
        wet_season,
        ave_larv_cont
        )
    
    ## Extract train and test data sets
    train_ind <- sample(
      1:nrow(all_data),
      size = floor(0.95 * nrow(all_data))
    )
    
    train_data <- all_data[train_ind, ]
    test_data <- all_data[-train_ind, ]
    
    ## specify df of covariate values
    all_covar_df <- data.frame(
      select(all_data, -c(time, lon, lat, log_saliva_elisa))
    )
    
    train_covar_df <- all_covar_df[train_ind, ]
    test_covar_df <- all_covar_df[-train_ind, ]
      
    ## extract coordinates as matrix, ignoring repeats
    all_coords <- all_data %>% 
      filter(time == 1) %>% 
      select(lon, lat) %>% 
      as.matrix()
    
    ## create mesh, good documentation available to understand all options
    mesh <- inla.mesh.2d(
      loc = all_coords,
      max.edge = c(300, 600)
    )
    
    # specify spde
    spde <- inla.spde2.matern(mesh)
    
    # Need to specify index with spde and group (if there are replicates)
    s.index <- inla.spde.make.index(
      "spatial.field", 
      n.spde = spde$n.spde,
      n.group = 4
    )
    
    ## A specifies something about edge length based on the mesh
    train_A <- inla.spde.make.A(
      mesh = mesh, 
      loc = as.matrix(select(train_data, lon, lat)),
      group = train_data$time
    )
    
    test_A <- inla.spde.make.A(
      mesh = mesh, 
      loc = as.matrix(select(test_data, lon, lat)),
      group = test_data$time
    )
    
    ## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
    train_stack <- inla.stack(
      data = list(y = train_data$log_saliva_elisa),
      A = list(train_A, 1),
      effects = list(
        s.index,
        list(train_covar_df = train_covar_df)
      ),
      tag = "train"
    )
    
    test_stack <- inla.stack(
      data = list(y = rep(NA, nrow(test_data))),
      A = list(test_A, 1),
      effects = list(
        s.index,
        list(test_covar_df = test_covar_df)
      ),
      tag = "test"
    )
    
    full_stack <- inla.stack(train_stack, test_stack)
    
    ## specify model formula, 'f()' incorporates spatial effect and replicate 
    formula <- y ~ #0 + Intercept
      gender + 
      age_cented7  + #distance_to_river_scaled +
      #modal_land_type +
      num_toilets_in_home + num_domestic_water_containers_in_home +
      insecticide_spray + larvicide_applied_to_water  +
      #NFI250_home  +
      wet_season +
      ave_larv_cont +
      f(
        spatial.field, 
        model = spde, 
        group = spatial.field.group, 
        control.group = list(model = "iid")
      )
      
    
    ## fixed effect priors
    coeff_priors <- list(
        mean.intercept = 0,
        prec.intercept = 1/(2.5^2),
        mean = list(default = 0),
        prec = list(default = 1/(2.5^2))
    )
  
    ## Fit model
    fit_full_wo_enviro <- inla(
      formula, 
      data = inla.stack.data(full_stack),
      control.predictor = list(
        A = inla.stack.A(full_stack),
        compute = TRUE
      ),
      control.fixed = coeff_priors
    )
    
    
    index_pred <- inla.stack.index(full_stack, "test")$data
  
    preds_df <- data.frame(
      "pred" = fit_full_wo_enviro$summary.linear.predictor[index_pred, "mean"],
      "obs" = test_data$log_saliva_elisa,
      "pred_iter" = rep(j, nrow(test_data))
    )
    
    
    fit_full_wo_enviro_preds <- bind_rows(fit_full_wo_enviro_preds, preds_df)
  }
  
  
  ## Saves predictions
  write.csv(fit_full_wo_enviro_preds, file = here("output", "fit_full_wo_enviro_preds.csv"), row.names = FALSE)
  
  
  ### Fit model on full data yto get larval preds
  all_A <- inla.spde.make.A(
    mesh = mesh, 
    loc = as.matrix(select(all_data, lon, lat)),
    group = all_data$time
  )
    
  ## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
  all_stack <- inla.stack(
    data = list(y = all_data$log_saliva_elisa),
    A = list(all_A, 1),
    effects = list(
      s.index,
      list(all_covar_df = all_covar_df)
    ),
    tag = "train"
  )
    
  ## Fit model
  fit_full_wo_enviro_no_pred <- inla(
    formula, 
    data = inla.stack.data(all_stack),
    control.predictor = list(
      A = inla.stack.A(all_stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )
  
  larval_pred_est[3, ] <- fit_full_wo_enviro_no_pred$summary.fixed["ave_larv_cont", c("mean", "0.025quant", "0.975quant")]
}
```

\newpage
```{r cross validation comparison plot}
bind_rows(
  data.frame(fit_full_wo_larval_preds, model = "Full wo larval"),
  data.frame(fit_full_w_larval_preds, model = "Full w larval"),
  data.frame(fit_full_wo_enviro_preds, model = "No enviro w larval")
) %>% 
ggplot(aes(x = obs, y = pred, color = model)) +
  geom_point(alpha = 0.8) +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0)
  
```


```{r cross validation comparison table}
write.csv(larval_pred_est, here("output", "larval_pred_est.csv"), row.names = FALSE)


larval_MSE <- c(
  fit_full_wo_larval_preds %>% 
    mutate(mse_wo_sum = (pred - obs)^2) %>% 
    select(mse_wo_sum) %>% 
    sum() / nrow(fit_full_wo_larval_preds),
  fit_full_w_larval_preds %>% 
    mutate(mse_wo_sum = (pred - obs)^2) %>% 
    select(mse_wo_sum) %>% 
    sum() / nrow(fit_full_w_larval_preds),
  fit_full_wo_enviro_preds %>% 
    mutate(mse_wo_sum = (pred - obs)^2) %>% 
    select(mse_wo_sum) %>% 
    sum() / nrow(fit_full_wo_enviro_preds)
)


data.frame(
  "Model" = c("Without larval", "With larval", "With larval and without environmental"),
  "MSE" = round(larval_MSE, 4), 
  larval_pred_est
) %>% 
  mutate("Larval predictor estimate (95% BCI)" = ifelse(
    is.na(mean),
    "NA",
    paste0(
      round(mean, 3), " (", round(X0.025quant, 3), ", ", round(X0.975quant, 3), ")"
    )
  )) %>% 
  select("Full model" = Model, "Prediction MSE" = MSE, "Larval predictor estimate (95% BCI)") %>% 
kbl(booktabs = TRUE) %>% 
  kable_styling()
```

\newpage

```{r larval-model-forest_plot}
larval_fit <- fit_full_w_larval_no_pred

larval_fit_df <- larval_fit$summary.fixed %>% 
  mutate(unordered_names = rownames(larval_fit$summary.fixed)) %>% 
  mutate(pred_names = factor(
    unordered_names,
    levels = c(pred_rownames_ordered, "ave_larv_cont"),
    labels = c(pred_names_vec, "Larval containers")
  )) %>% 
  select(quant025 = "0.025quant", mean = "mean", quant975 = "0.975quant", pred_names) 

    
pdf(here("output", "larval-model-forest-plot.pdf"))

larval_fit_df %>% 
  filter(pred_names != "(Intercept)") %>% 
  ggplot(aes(x = mean, y = pred_names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("") +
  scale_y_discrete(limits = rev)

dev.off()
```


```{r load-larval-model-forest-plot, eval = TRUE, fig.cap="Full model results with larvae containg water containers added."}
include_graphics(here("output", "larval-model-forest-plot.pdf"))
```
\newpage

### Containters with larvae as response
```{r larval-res-model, eval = FALSE}
if(!params$refit_larval_fit) {
  
  larval_res_fit <- readRDS(here("output", "larval_res_fit.rds"))
  
} else {
  
  ## extract relevant data (not sure if sorting is necessary)
  coords_st <- aedes_larval_red %>% 
    filter(!is.na(ave_larv_cont)) %>% 
    arrange(study_id, time) %>% 
    select(
      time, 
      lon = x, lat = y, 
      distance_to_river_scaled,
      modal_land_type,
      num_toilets_in_home, num_domestic_water_containers_in_home,
      insecticide_spray, larvicide_applied_to_water,
      NFI250_home16,
      wet_season,
      ave_larv_cont
      )
  
  ## specify df of covariate values including intercept
  covar_df <- data.frame(
    # Intercept = rep(1, nrow(coords_st)),
    select(coords_st, -c(time, lon, lat, ave_larv_cont))
  )
    
  ## extract coordinates as matrix, ignoring repeats
  coords <- select(coords_st, lon, lat) %>% 
    distinct() %>% 
    as.matrix()
  
  ## create mesh, good documentation available to understand all options
  mesh <- inla.mesh.2d(
    loc = coords,
    max.edge = c(300, 600)
  )
  
  # specify spde
  spde <- inla.spde2.matern(mesh)
  
  # Need to specify index with spde and group (if there are replicates)
  s.index <- inla.spde.make.index(
    "spatial.field", 
    n.spde = spde$n.spde,
    n.group = 4
  )
  
  ## A specifies something about edge length based on the mesh
  A <- inla.spde.make.A(
    mesh = mesh, 
    loc = as.matrix(select(coords_st, lon, lat)), 
    group = coords_st$time
  )
  
  ## Prep data for inla call, "A" needs to have a 1 for each list element in effects, aside from index
  stack <- inla.stack(
    data = list(y = sqrt(coords_st$ave_larv_cont)),
    A = list(A, 1),
    effects = list(
      s.index,
      list(covar_df = covar_df)
    ),
    tag = "est"
  )
  
  ## specify model formula, 'f()' incorporates spatial effect and replicate 
  formula <- y ~ #0 + Intercept
    distance_to_river_scaled +
    modal_land_type +
    num_toilets_in_home + num_domestic_water_containers_in_home +
    insecticide_spray + larvicide_applied_to_water  +
    NFI250_home16  +
    wet_season +
    f(
      spatial.field, 
      model = spde, 
      group = spatial.field.group, 
      control.group = list(model = "iid")
    )
    
  
  ## fixed effect priors
  coeff_priors <- list(
      mean.intercept = 0,
      prec.intercept = 1/(2.5^2),
      mean = list(default = 0),
      prec = list(default = 1/(2.5^2))
  )
  
  larval_res_fit <- inla(
    formula, 
    data = inla.stack.data(stack),
    control.predictor = list(
      A = inla.stack.A(stack),
      compute = TRUE
    ),
    control.fixed = coeff_priors
  )

  
  saveRDS(larval_res_fit, here("output", "larval_res_fit.rds"))
  
}
```


```{r}
ggplot_inla_residuals2(
  larval_res_fit, 
  observed = stack$data$data[, 1], 
  se = FALSE
) +
  theme_bw()
```

```{r eval = FALSE}
index_pred <- inla.stack.index(stack, "est")$data

data.frame(
  "pred" = larval_res_fit$summary.linear.predictor[index_pred, "mean"],
  "obs" = stack$data$data[, 1]
) %>% 
ggplot(aes(x = obs, y = pred)) +
  geom_point(alpha = 0.8) +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0)
  
```



```{r larval-res-model-forest_plot, eval = FALSE}
pdf(here("output", "larval-res-model-forest-plot.pdf"))

larval_res_fit$summary.fixed %>% 
  select(quant025 = "0.025quant", median = "0.5quant", quant975 = "0.975quant") %>% 
  mutate(names = c(
    "(Intercept)",
    "Distance to river", 
    "Rice paddy",
    "Cropland",
    "Toilets",
    "Water containers",
    "Insecticide",
    "Larvicide",
    "NFI",
    "Wet season"
  )) %>% 
  filter(names != "(Intercept)") %>% 
  ggplot(aes(x = median, y = names)) +
    geom_point() +
    geom_linerange(aes(xmin = quant025, xmax = quant975)) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    theme_bw() +
    theme(panel.border = element_blank()) +
    xlab("") +
    ylab("")

dev.off()
```


```{r load-larval-res-model-forest-plot, eval = FALSE, fig.cap="Results with larvae containg water containers as response"}
include_graphics(here("output", "larval-res-model-forest-plot.pdf"))
```




```{r}
library(splines)

spline_larval_res_fit <- lm(
  formula = sqrt(ave_larv_cont) ~ #0 + Intercept
    distance_to_river_scaled +
    modal_land_type +
    num_toilets_in_home + num_domestic_water_containers_in_home +
    insecticide_spray + larvicide_applied_to_water  +
    bs(NFI250_home)  +
    wet_season,
  data = filter(aedes_larval_red, !is.na(ave_larv_cont))
    
)


data.frame("mean" = spline_larval_res_fit$coefficients, confint(spline_larval_res_fit))

plot(spline_larval_res_fit)
```

